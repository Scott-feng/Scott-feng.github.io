<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Scott Blog</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2019-06-01T23:24:22.916Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>Scott Shen</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Laravel Passport</title>
    <link href="http://yoursite.com/2019/06/01/Laravel-Passport/"/>
    <id>http://yoursite.com/2019/06/01/Laravel-Passport/</id>
    <published>2019-06-01T02:41:17.000Z</published>
    <updated>2019-06-01T23:24:22.916Z</updated>
    
    <content type="html"><![CDATA[<h2 id="使用Laravel-Passport-实现api用户认证"><a href="#使用Laravel-Passport-实现api用户认证" class="headerlink" title="使用Laravel Passport 实现api用户认证"></a>使用Laravel Passport 实现api用户认证</h2><p>参考：</p><ul><li><a href="https://learnku.com/laravel/t/22586#db06c7" target="_blank" rel="noopener">使用Laravel Passport</a></li></ul><h3 id="Passport配置"><a href="#Passport配置" class="headerlink" title="Passport配置"></a>Passport配置</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">composer <span class="keyword">require</span> laravel/passport</span><br><span class="line"></span><br><span class="line"><span class="comment">//表迁移，生成oauth相关的表</span></span><br><span class="line">php artisan migrate</span><br><span class="line"></span><br><span class="line">php artisan passport:install</span><br></pre></td></tr></table></figure><a id="more"></a><p><em>app/User.php</em><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">use</span> <span class="title">Laravel</span>\<span class="title">Passport</span>\<span class="title">HasApiTokens</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Authenticatable</span> </span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">Notifiable</span>,<span class="title">HasApiTokens</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>引入 <strong>HasApiTokens</strong></p><p><em>app/Providers/AuthServiceProvider.php</em><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Providers</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Facades</span>\<span class="title">Gate</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Support</span>\<span class="title">Providers</span>\<span class="title">AuthServiceProvider</span> <span class="title">as</span> <span class="title">ServiceProvider</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Laravel</span>\<span class="title">Passport</span>\<span class="title">Passport</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AuthServiceProvider</span> <span class="keyword">extends</span> <span class="title">ServiceProvider</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The policy mappings for the application.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $policies = [</span><br><span class="line">         <span class="string">'App\Model'</span> =&gt; <span class="string">'App\Policies\ModelPolicy'</span>,</span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Register any authentication / authorization services.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;registerPolicies();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//引入Ppassport routes,</span></span><br><span class="line">        <span class="comment">//注册必要的路由去颁发访问令牌，撤销访问令牌，客户端和个人令牌</span></span><br><span class="line">        Passport::routes();</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><em>config/auth.php</em><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'api'</span> =&gt; [</span><br><span class="line">    <span class="comment">//driver 改为passport</span></span><br><span class="line">    <span class="string">'driver'</span> =&gt; <span class="string">'passport'</span>,</span><br><span class="line">    <span class="string">'provider'</span> =&gt; <span class="string">'users'</span>,</span><br><span class="line">    <span class="string">'hash'</span> =&gt; <span class="keyword">false</span>,</span><br><span class="line">],</span><br></pre></td></tr></table></figure></p><h3 id="添加api-路由"><a href="#添加api-路由" class="headerlink" title="添加api 路由"></a>添加api 路由</h3><p><em>routes/api.php</em><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">Route::group([</span><br><span class="line">    <span class="string">'prefix'</span> =&gt; <span class="string">'auth'</span></span><br><span class="line">], <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    Route::post(<span class="string">'login'</span>, <span class="string">'AuthController@login'</span>);</span><br><span class="line">    Route::post(<span class="string">'signup'</span>, <span class="string">'AuthController@signup'</span>);</span><br><span class="line"></span><br><span class="line">    Route::group([</span><br><span class="line">      <span class="string">'middleware'</span> =&gt; <span class="string">'auth:api'</span></span><br><span class="line">    ], <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Route::get(<span class="string">'logout'</span>, <span class="string">'AuthController@logout'</span>);</span><br><span class="line">        Route::get(<span class="string">'user'</span>, <span class="string">'AuthController@user'</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p><h3 id="创建控制器"><a href="#创建控制器" class="headerlink" title="创建控制器"></a>创建控制器</h3><p><em>app/Http/Controllers/AuthController.php</em></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">User</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Carbon</span>\<span class="title">Carbon</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Auth</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Facades</span>\<span class="title">Log</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AuthController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">signup</span><span class="params">(Request $request)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $request-&gt;validate([</span><br><span class="line">            <span class="string">'name'</span> =&gt; <span class="string">'required|string'</span>,</span><br><span class="line">            <span class="string">'email'</span> =&gt; <span class="string">'required|string|email'</span>,</span><br><span class="line">            <span class="string">'password'</span> =&gt; <span class="string">'required|string'</span>,</span><br><span class="line">        ]);</span><br><span class="line"></span><br><span class="line">        $user = <span class="keyword">new</span> User([</span><br><span class="line">            <span class="string">'name'</span>=&gt;$request-&gt;name,</span><br><span class="line">            <span class="string">'email'</span>=&gt;$request-&gt;email,</span><br><span class="line">            <span class="string">'password'</span>=&gt;bcrypt($request-&gt;password)</span><br><span class="line">        ]);</span><br><span class="line"></span><br><span class="line">        $user-&gt;save();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> response()-&gt;json([</span><br><span class="line">            <span class="string">'message'</span>=&gt;<span class="string">'create user success'</span></span><br><span class="line">        ],<span class="number">201</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span><span class="params">(Request $request)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $request-&gt;validate([</span><br><span class="line">            <span class="string">'email'</span> =&gt; <span class="string">'required|string|email'</span>,</span><br><span class="line">            <span class="string">'password'</span> =&gt; <span class="string">'required|string'</span>,</span><br><span class="line">            <span class="string">'remember'</span> =&gt; <span class="string">'boolean'</span></span><br><span class="line">        ]);</span><br><span class="line"></span><br><span class="line">        $credentials = request([<span class="string">'email'</span>,<span class="string">'password'</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!Auth::attempt($credentials)) &#123;</span><br><span class="line">            <span class="keyword">return</span> response()-&gt;json([</span><br><span class="line">                <span class="string">'message'</span> =&gt; <span class="string">'unauthorized'</span></span><br><span class="line">            ],<span class="number">401</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $user = $request-&gt;user();</span><br><span class="line"></span><br><span class="line">        $tokenResult = $user-&gt;createToken(<span class="string">'Personal Access Token'</span>);</span><br><span class="line">        Log::info($tokenResult);</span><br><span class="line">        $token = $tokenResult-&gt;token;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ($request-&gt;remember_me) &#123;</span><br><span class="line">            $token-&gt;expires_at = Carbon::now()-&gt;addWeeks(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $token-&gt;save();</span><br><span class="line">        <span class="keyword">return</span> response()-&gt;json([</span><br><span class="line">            <span class="string">'access_token'</span> =&gt; $tokenResult-&gt;accessToken,</span><br><span class="line">            <span class="string">'token_type'</span> =&gt; <span class="string">'Bearer'</span>,</span><br><span class="line">            <span class="string">'expires_at'</span> =&gt; Carbon::parse(</span><br><span class="line">                $tokenResult-&gt;token-&gt;expires_at</span><br><span class="line">            )-&gt;toDateTimeString()</span><br><span class="line">        ]);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">logout</span><span class="params">(Request $request)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $request-&gt;user()-&gt;token()-&gt;revoke();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> response()-&gt;json([</span><br><span class="line">            <span class="string">'message'</span> =&gt; <span class="string">'logged out'</span></span><br><span class="line">        ]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">user</span><span class="params">(Request $request)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> response()-&gt;json($request-&gt;user());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>public function login(Request $request)中的</p><p><code>$tokenResult = $user-&gt;createToken(&#39;Personal Access Token&#39;);</code></p><p>$tokenResult的数据结构</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;accessToken&quot;:&quot;eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImp0aSI6IjcxNDQyZmVjMzBhNGI3ZWVjMmY2YTMyOTQwYjkyNjkzNzRjNTE1MTNjOWFhMzVlYTY1ODRl......&quot;,</span><br><span class="line">&quot;token&quot;:&#123;&quot;id&quot;:&quot;71442fec30a4b7eec2f6a32940b9269374c51513c9aa35ea6584e051e6e21075f2255c765028a44a&quot;,</span><br><span class="line">&quot;user_id&quot;:52,&quot;client_id&quot;:1,</span><br><span class="line">&quot;name&quot;:&quot;Personal Access Token&quot;,&quot;scopes&quot;:[],&quot;revoked&quot;:false,&quot;created_at&quot;:&quot;2019-06-01 02:30:45&quot;,&quot;updated_at&quot;:&quot;2019-06-01 02:30:45&quot;,</span><br><span class="line">&quot;expires_at&quot;:&quot;2020-06-01 02:30:45&quot;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>logout调用<br><code>$request-&gt;user()-&gt;token()-&gt;revoke();</code></p><h3 id="Postman测试"><a href="#Postman测试" class="headerlink" title="Postman测试"></a>Postman测试</h3><p><a href="https://app.getpostman.com/run-collection/f22c66cf3d144b138982" target="_blank" rel="noopener">Run in Postman</a><br>其中的form.test改为自己的项目域名。</p><p>signup<br><strong>Headers</strong> 设置<br><code>Content-Type:application/json</code><br><code>X-Requested-With:XMLHttpRequest</code><br><img src="http://ww2.sinaimg.cn/large/006tNc79gy1g3m03alns3j31hs0u0ad7.jpg" alt="sigup"></p><p>login<br><img src="http://ww4.sinaimg.cn/large/006tNc79gy1g3mg8932yfj30s60f7gml.jpg" alt="Login"></p><p>logout<br><img src="http://ww4.sinaimg.cn/large/006tNc79gy1g3mgadyp8oj30s80dpglw.jpg" alt="logout"></p><p>user<br><img src="http://ww1.sinaimg.cn/large/006tNc79gy1g3mgbgfwbqj30rq0e8t92.jpg" alt="user"></p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;使用Laravel-Passport-实现api用户认证&quot;&gt;&lt;a href=&quot;#使用Laravel-Passport-实现api用户认证&quot; class=&quot;headerlink&quot; title=&quot;使用Laravel Passport 实现api用户认证&quot;&gt;&lt;/a&gt;使用Laravel Passport 实现api用户认证&lt;/h2&gt;&lt;p&gt;参考：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://learnku.com/laravel/t/22586#db06c7&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;使用Laravel Passport&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;Passport配置&quot;&gt;&lt;a href=&quot;#Passport配置&quot; class=&quot;headerlink&quot; title=&quot;Passport配置&quot;&gt;&lt;/a&gt;Passport配置&lt;/h3&gt;&lt;figure class=&quot;highlight php&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;composer &lt;span class=&quot;keyword&quot;&gt;require&lt;/span&gt; laravel/passport&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//表迁移，生成oauth相关的表&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;php artisan migrate&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;php artisan passport:install&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="Tech" scheme="http://yoursite.com/categories/Tech/"/>
    
    
      <category term="laravel" scheme="http://yoursite.com/tags/laravel/"/>
    
      <category term="passport" scheme="http://yoursite.com/tags/passport/"/>
    
      <category term="api" scheme="http://yoursite.com/tags/api/"/>
    
  </entry>
  
  <entry>
    <title>laravel factories</title>
    <link href="http://yoursite.com/2019/05/26/laravel-factories/"/>
    <id>http://yoursite.com/2019/05/26/laravel-factories/</id>
    <published>2019-05-26T00:56:14.000Z</published>
    <updated>2019-05-27T13:32:37.814Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Laravel-数据填充"><a href="#Laravel-数据填充" class="headerlink" title="Laravel 数据填充"></a>Laravel 数据填充</h2><p>参考：</p><ul><li><a href="https://learnku.com/courses/laravel-intermediate-training/5.8/seeding-data/4163" target="_blank" rel="noopener">假数据填充</a></li><li><a href="https://learnku.com/docs/laravel/5.8/seeding/3929" target="_blank" rel="noopener">数据填充</a></li><li><a href="https://learnku.com/docs/laravel/5.8/database-testing/3940#writing-factories" target="_blank" rel="noopener">模型工厂</a></li><li><a href="https://scotch.io/@wisdomanthoni/make-your-laravel-seeder-using-model-factories" target="_blank" rel="noopener">make-your-laravel-seeder-using-model-factories</a></li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//文件名单数</span></span><br><span class="line">php artisan make:factory ThreadFactory --model=Thread</span><br><span class="line">php artisan make:factory ReplyFactory --model=Reply</span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="创建模型工厂文件"><a href="#创建模型工厂文件" class="headerlink" title="创建模型工厂文件"></a>创建模型工厂文件</h3><p>database/factories/UserFactory.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/** <span class="doctag">@var</span> \Illuminate\Database\Eloquent\Factory $factory */</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">User</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Str</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Faker</span>\<span class="title">Generator</span> <span class="title">as</span> <span class="title">Faker</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">|--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">| Model Factories</span></span><br><span class="line"><span class="comment">|--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">|</span></span><br><span class="line"><span class="comment">| This directory should contain each of the model factory definitions for</span></span><br><span class="line"><span class="comment">| your application. Factories provide a convenient way to generate new</span></span><br><span class="line"><span class="comment">| model instances for testing / seeding your application's database.</span></span><br><span class="line"><span class="comment">|</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">$factory-&gt;define(User::class, <span class="function"><span class="keyword">function</span> <span class="params">(Faker $faker)</span> </span>&#123;</span><br><span class="line"><span class="comment">//bcrtpy消耗cpu的函数，静态变量不用每次重新计算</span></span><br><span class="line">    <span class="keyword">static</span> $password;</span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">        <span class="string">'name'</span> =&gt; $faker-&gt;name,</span><br><span class="line">        <span class="string">'email'</span> =&gt; $faker-&gt;unique()-&gt;safeEmail,</span><br><span class="line">        <span class="string">'email_verified_at'</span> =&gt; now(),</span><br><span class="line">        <span class="string">'password'</span> =&gt; $password ?: $password = bcrypt(<span class="string">'123456'</span>), <span class="comment">// password</span></span><br><span class="line">        <span class="string">'remember_token'</span> =&gt; Str::random(<span class="number">10</span>),</span><br><span class="line">    ];</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p><p>database/factories/ThreadFactory.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* <span class="doctag">@var</span> $factory \Illuminate\Database\Eloquent\Factory */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Thread</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Faker</span>\<span class="title">Generator</span> <span class="title">as</span> <span class="title">Faker</span>;</span><br><span class="line"></span><br><span class="line">$factory-&gt;define(Thread::class, <span class="function"><span class="keyword">function</span> <span class="params">(Faker $faker)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">        <span class="comment">//user_id字段在seeder文件中处理</span></span><br><span class="line">        <span class="string">'title'</span>=&gt;$faker-&gt;sentence,</span><br><span class="line">        <span class="string">'body'</span>=&gt;$faker-&gt;paragraph,</span><br><span class="line">    ];</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p><p>database/factories/ReplyFactory.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* <span class="doctag">@var</span> $factory \Illuminate\Database\Eloquent\Factory */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Reply</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Faker</span>\<span class="title">Generator</span> <span class="title">as</span> <span class="title">Faker</span>;</span><br><span class="line"></span><br><span class="line">$factory-&gt;define(Reply::class, <span class="function"><span class="keyword">function</span> <span class="params">(Faker $faker)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">    <span class="comment">//user_id,thread_id在seeder中处理</span></span><br><span class="line">        <span class="string">'body'</span>=&gt;$faker-&gt;paragraph,</span><br><span class="line">    ];</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p><h3 id="创建数据填充文件"><a href="#创建数据填充文件" class="headerlink" title="创建数据填充文件"></a>创建数据填充文件</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//文件名复数</span></span><br><span class="line">php artisan make:seed UsersTableSeeder</span><br><span class="line">php artisan make:seed ThreadsTableSeeder</span><br></pre></td></tr></table></figure><p>database/seeds/UsrsTableSeeder<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Seeder</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">User</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UsersTableSeeder</span> <span class="keyword">extends</span> <span class="title">Seeder</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Run the database seeds.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">       factory(User::class,<span class="number">50</span>)-&gt;create();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>database/seeds/TreadsTableSeeder</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Seeder</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Thread</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ThreadsTableSeeder</span> <span class="keyword">extends</span> <span class="title">Seeder</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Run the database seeds.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//取得所有的用户id，转换为数组</span></span><br><span class="line">        $user_ids =\App\User::all()-&gt;pluck(<span class="string">'id'</span>)-&gt;toArray();</span><br><span class="line">        $faker = app(Faker\Generator::class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//make() method return collection,collection is in memory</span></span><br><span class="line">        $threads = factory(<span class="string">'App\Thread'</span>,<span class="number">90</span>)-&gt;make()-&gt;each(<span class="function"><span class="keyword">function</span> <span class="params">($thread)</span> <span class="title">use</span><span class="params">($user_ids,$faker)</span></span>&#123;</span><br><span class="line">            $thread-&gt;user_id = $faker-&gt;randomElement($user_ids);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//store to database</span></span><br><span class="line">        Thread::insert($threads-&gt;toArray());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>database/seeds/RepliesTableSeeder</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Seeder</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">User</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Thread</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Reply</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RepliesTableSeeder</span> <span class="keyword">extends</span> <span class="title">Seeder</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Run the database seeds.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $user_ids = User::all()-&gt;pluck(<span class="string">'id'</span>)-&gt;toArray();</span><br><span class="line">        $faker = app(Faker\Generator::class);</span><br><span class="line">        $thread_ids = Thread::all()-&gt;pluck(<span class="string">'id'</span>)-&gt;toArray();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//collection</span></span><br><span class="line">        $replies = factory(<span class="string">'App\Reply'</span>,<span class="number">100</span>)-&gt;make()-&gt;each(<span class="function"><span class="keyword">function</span> <span class="params">($reply)</span> <span class="title">use</span><span class="params">($user_ids,$thread_ids,$faker)</span></span>&#123;</span><br><span class="line">           $reply-&gt;user_id = $faker-&gt;randomElement($user_ids);</span><br><span class="line">           $reply-&gt;thread_id = $faker-&gt;randomElement($thread_ids);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        Reply::insert($replies-&gt;toArray());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="运行-Seeders"><a href="#运行-Seeders" class="headerlink" title="运行 Seeders"></a>运行 Seeders</h3><p>重新生成composer的加载器<br><code>composer dump-autoload</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">php artisan db:seed</span><br><span class="line">//运行特定的seeder</span><br><span class="line">php artisan db:seed --class=UsersTableSeeder</span><br></pre></td></tr></table></figure><p><code>migrate:refresh</code> 这个命令来填充数据库，该命令会回滚并重新运行所有迁移。这个命令可以用来重建数据库：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php artisan migrate:refresh --seed</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;Laravel-数据填充&quot;&gt;&lt;a href=&quot;#Laravel-数据填充&quot; class=&quot;headerlink&quot; title=&quot;Laravel 数据填充&quot;&gt;&lt;/a&gt;Laravel 数据填充&lt;/h2&gt;&lt;p&gt;参考：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://learnku.com/courses/laravel-intermediate-training/5.8/seeding-data/4163&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;假数据填充&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://learnku.com/docs/laravel/5.8/seeding/3929&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;数据填充&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://learnku.com/docs/laravel/5.8/database-testing/3940#writing-factories&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;模型工厂&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://scotch.io/@wisdomanthoni/make-your-laravel-seeder-using-model-factories&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;make-your-laravel-seeder-using-model-factories&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight php&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//文件名单数&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;php artisan make:factory ThreadFactory --model=Thread&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;php artisan make:factory ReplyFactory --model=Reply&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="Tech" scheme="http://yoursite.com/categories/Tech/"/>
    
    
      <category term="laravel" scheme="http://yoursite.com/tags/laravel/"/>
    
      <category term="seeder" scheme="http://yoursite.com/tags/seeder/"/>
    
  </entry>
  
  <entry>
    <title>Hexo Blog</title>
    <link href="http://yoursite.com/2019/05/19/Hexo-Blog/"/>
    <id>http://yoursite.com/2019/05/19/Hexo-Blog/</id>
    <published>2019-05-19T10:56:53.000Z</published>
    <updated>2019-05-26T05:23:33.063Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Hexo-博客的搭建"><a href="#Hexo-博客的搭建" class="headerlink" title="Hexo 博客的搭建"></a>Hexo 博客的搭建</h2><p>参考：</p><ul><li><a href="https://hexo.io/zh-cn/" target="_blank" rel="noopener">Hexo</a></li><li><a href="https://www.liaoxuefeng.com/wiki/896043488029600/900375748016320" target="_blank" rel="noopener">git多人协作</a></li><li><a href="http://theme-next.iissnan.com/" target="_blank" rel="noopener">theme nexT</a></li><li><a href="https://github.com/theme-next/hexo-theme-next" target="_blank" rel="noopener">theme nexT github</a></li></ul><h3 id="安装前提"><a href="#安装前提" class="headerlink" title="安装前提"></a>安装前提</h3><ul><li>Node.js</li><li>git</li></ul><p><code>npm install -g hexo-cli</code><br><a id="more"></a></p><h3 id="建站"><a href="#建站" class="headerlink" title="建站"></a>建站</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ hexo init &lt;folder&gt;</span><br><span class="line">$ <span class="built_in">cd</span> &lt;folder&gt;</span><br><span class="line">$ npm install</span><br></pre></td></tr></table></figure><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>__config.yml<br><a href="https://hexo.io/zh-cn/docs/configuration" target="_blank" rel="noopener">详细配置</a></p><h3 id="nexT主题安装"><a href="#nexT主题安装" class="headerlink" title="nexT主题安装"></a>nexT主题安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://github.com/theme-next/hexo-theme-next themes/next</span><br></pre></td></tr></table></figure><p><code>theme: next</code></p><h3 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 推送到 dev远程分支</span></span><br><span class="line">$ git push origin dev</span><br><span class="line"></span><br><span class="line">$ git checkout -b branch-name origin/branch-name</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除分支</span></span><br><span class="line">$ git branch -d (branchname)</span><br></pre></td></tr></table></figure><p>__config.yml<br>部署到主分支<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">deploy:</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">git</span></span><br><span class="line">  <span class="comment"># repo: https://gh_token@github.com/Scott-feng/scott-feng.github.io.git</span></span><br><span class="line"><span class="attr">  repo:</span> <span class="string">git@github.com:Scott-feng/scott-feng.github.io.git</span></span><br><span class="line"><span class="attr">  branch:</span> <span class="string">master</span></span><br></pre></td></tr></table></figure></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ hexo clean </span><br><span class="line">$ hexo g</span><br><span class="line">$ hexo d</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;Hexo-博客的搭建&quot;&gt;&lt;a href=&quot;#Hexo-博客的搭建&quot; class=&quot;headerlink&quot; title=&quot;Hexo 博客的搭建&quot;&gt;&lt;/a&gt;Hexo 博客的搭建&lt;/h2&gt;&lt;p&gt;参考：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://hexo.io/zh-cn/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Hexo&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://www.liaoxuefeng.com/wiki/896043488029600/900375748016320&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;git多人协作&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://theme-next.iissnan.com/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;theme nexT&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/theme-next/hexo-theme-next&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;theme nexT github&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;安装前提&quot;&gt;&lt;a href=&quot;#安装前提&quot; class=&quot;headerlink&quot; title=&quot;安装前提&quot;&gt;&lt;/a&gt;安装前提&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;Node.js&lt;/li&gt;
&lt;li&gt;git&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;code&gt;npm install -g hexo-cli&lt;/code&gt;&lt;br&gt;
    
    </summary>
    
      <category term="Tech" scheme="http://yoursite.com/categories/Tech/"/>
    
    
      <category term="hexo" scheme="http://yoursite.com/tags/hexo/"/>
    
  </entry>
  
  <entry>
    <title>Laravel Notifications toDatabase</title>
    <link href="http://yoursite.com/2019/05/18/Laravel-Notifications-toDatabase/"/>
    <id>http://yoursite.com/2019/05/18/Laravel-Notifications-toDatabase/</id>
    <published>2019-05-17T23:51:22.000Z</published>
    <updated>2019-05-19T08:08:07.755Z</updated>
    
    <content type="html"><![CDATA[<p>参考:<br><a href="https://learnku.com/docs/laravel/5.8/notifications/3921" target="_blank" rel="noopener">消息通知</a></p><h3 id="Prepare-notification-database"><a href="#Prepare-notification-database" class="headerlink" title="Prepare notification database"></a>Prepare notification database</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">php artisan notifications:table</span><br><span class="line">php artisan migrate</span><br><span class="line"></span><br><span class="line"><span class="comment">#add users table notification_count column</span></span><br><span class="line">php artisan make:migration add_notification_count_to_users_table --table=users</span><br></pre></td></tr></table></figure><h3 id="Generate-notification-class"><a href="#Generate-notification-class" class="headerlink" title="Generate notification class"></a>Generate notification class</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php artisan make:notification</span><br></pre></td></tr></table></figure><a id="more"></a><p>app/Notifications/TopicReplied</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Notifications</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Bus</span>\<span class="title">Queueable</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Notifications</span>\<span class="title">Notification</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">Queue</span>\<span class="title">ShouldQueue</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Notifications</span>\<span class="title">Messages</span>\<span class="title">MailMessage</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Models</span>\<span class="title">Message</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Auth</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TopicReplied</span> <span class="keyword">extends</span> <span class="title">Notification</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">Queueable</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create a new notification instance.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> $message;</span><br><span class="line">    <span class="keyword">public</span> $topic;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Message $message)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;message = $message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the notification's delivery channels.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  mixed  $notifiable</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">via</span><span class="params">($notifiable)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> [<span class="string">'database'</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the array representation of the notification.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  mixed  $notifiable</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">toArray</span><span class="params">($notifiable)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            <span class="string">'from'</span>=&gt;Auth::user()-&gt;name,</span><br><span class="line">            <span class="string">'message'</span>=&gt;<span class="keyword">$this</span>-&gt;message-&gt;content,</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Get-all-notifications-use-Notifiable-trait"><a href="#Get-all-notifications-use-Notifiable-trait" class="headerlink" title="Get all notifications,use Notifiable trait"></a>Get all notifications,use Notifiable trait</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$notifications = $user-&gt;notifications()-&gt;paginate(<span class="number">20</span>);</span><br><span class="line"><span class="comment"># get the serialize data by toArray() method</span></span><br><span class="line">$notification-&gt;data toArray() data</span><br><span class="line"></span><br><span class="line">$user-&gt;notify(<span class="keyword">new</span> TopicReplied($message))</span><br></pre></td></tr></table></figure><h3 id="MarkAsRead"><a href="#MarkAsRead" class="headerlink" title="MarkAsRead"></a>MarkAsRead</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$user-&gt;unreadNotifications-&gt;markAsRead();</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;参考:&lt;br&gt;&lt;a href=&quot;https://learnku.com/docs/laravel/5.8/notifications/3921&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;消息通知&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;Prepare-notification-database&quot;&gt;&lt;a href=&quot;#Prepare-notification-database&quot; class=&quot;headerlink&quot; title=&quot;Prepare notification database&quot;&gt;&lt;/a&gt;Prepare notification database&lt;/h3&gt;&lt;figure class=&quot;highlight php&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;php artisan notifications:table&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;php artisan migrate&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#add users table notification_count column&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;php artisan make:migration add_notification_count_to_users_table --table=users&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;Generate-notification-class&quot;&gt;&lt;a href=&quot;#Generate-notification-class&quot; class=&quot;headerlink&quot; title=&quot;Generate notification class&quot;&gt;&lt;/a&gt;Generate notification class&lt;/h3&gt;&lt;figure class=&quot;highlight php&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;php artisan make:notification&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="Tech" scheme="http://yoursite.com/categories/Tech/"/>
    
    
      <category term="laravel" scheme="http://yoursite.com/tags/laravel/"/>
    
      <category term="notifications" scheme="http://yoursite.com/tags/notifications/"/>
    
  </entry>
  
  <entry>
    <title>ElasticSearch highlight</title>
    <link href="http://yoursite.com/2019/05/18/ElasticSearch-highlight/"/>
    <id>http://yoursite.com/2019/05/18/ElasticSearch-highlight/</id>
    <published>2019-05-17T23:36:51.000Z</published>
    <updated>2019-05-17T23:47:27.130Z</updated>
    
    <content type="html"><![CDATA[<p>Laravel Scout ElasticSearch搜索的基础上，搜索到的关键词加高亮的效果。<br>参考：<br><a href="https://learnku.com/articles/4038/tutorial-two-write-a-search-solve-the-search-results-highlight-the-problem-using-laravel-scout-elasticsearch-ik-word-segmentation" target="_blank" rel="noopener">搜索结果高亮</a><br><a href="https://learnku.com/docs/laravel/5.8/scout/3946" target="_blank" rel="noopener">Scout</a></p><h3 id="自定义搜索引擎"><a href="#自定义搜索引擎" class="headerlink" title="自定义搜索引擎"></a>自定义搜索引擎</h3><a id="more"></a><p>App\Services\EsEngine.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Laravel</span>\<span class="title">Scout</span>\<span class="title">Builder</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">ScoutEngines</span>\<span class="title">Elasticsearch</span>\<span class="title">ElasticsearchEngine</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Collection</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EsEngine</span> <span class="keyword">extends</span> <span class="title">ElasticsearchEngine</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">search</span><span class="params">(Builder $builder)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $result =  <span class="keyword">$this</span>-&gt;performSearch($builder, array_filter([</span><br><span class="line">            <span class="string">'numericFilters'</span> =&gt; <span class="keyword">$this</span>-&gt;filters($builder),</span><br><span class="line">            <span class="string">'size'</span> =&gt; $builder-&gt;limit,</span><br><span class="line">        ]));</span><br><span class="line">        <span class="keyword">return</span> $result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Perform the given search on the engine.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  Builder  $builder</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">performSearch</span><span class="params">(Builder $builder, array $options = [])</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    <span class="comment">//定义查询</span></span><br><span class="line">        $params = [</span><br><span class="line">            <span class="string">'index'</span> =&gt; <span class="keyword">$this</span>-&gt;index,</span><br><span class="line">            <span class="string">'type'</span> =&gt; $builder-&gt;model-&gt;searchableAs(),</span><br><span class="line">            <span class="string">'body'</span> =&gt; [</span><br><span class="line">                <span class="string">'query'</span> =&gt; [</span><br><span class="line">                    <span class="string">'bool'</span> =&gt; [</span><br><span class="line">                        <span class="string">'must'</span> =&gt; [</span><br><span class="line">                            [</span><br><span class="line">                                <span class="string">'query_string'</span> =&gt; [</span><br><span class="line">                                    <span class="string">'query'</span> =&gt; <span class="string">"&#123;$builder-&gt;query&#125;"</span>,</span><br><span class="line">                                ]</span><br><span class="line">                            ]</span><br><span class="line">                        ]</span><br><span class="line">                    ]</span><br><span class="line">                ],</span><br><span class="line">            ]</span><br><span class="line">        ];</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 这里使用了 highlight 的配置</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> ($builder-&gt;model-&gt;searchSettings</span><br><span class="line">            &amp;&amp; <span class="keyword">isset</span>($builder-&gt;model-&gt;searchSettings[<span class="string">'attributesToHighlight'</span>])</span><br><span class="line">        ) &#123;</span><br><span class="line">            $attributes = $builder-&gt;model-&gt;searchSettings[<span class="string">'attributesToHighlight'</span>];</span><br><span class="line">            <span class="keyword">foreach</span> ($attributes <span class="keyword">as</span> $attribute) &#123;</span><br><span class="line">                $params[<span class="string">'body'</span>][<span class="string">'highlight'</span>][<span class="string">'fields'</span>][$attribute] = <span class="keyword">new</span> \stdClass();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($options[<span class="string">'from'</span>])) &#123;</span><br><span class="line">            $params[<span class="string">'body'</span>][<span class="string">'from'</span>] = $options[<span class="string">'from'</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($options[<span class="string">'size'</span>])) &#123;</span><br><span class="line">            $params[<span class="string">'body'</span>][<span class="string">'size'</span>] = $options[<span class="string">'size'</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($options[<span class="string">'numericFilters'</span>]) &amp;&amp; count($options[<span class="string">'numericFilters'</span>])) &#123;</span><br><span class="line">            $params[<span class="string">'body'</span>][<span class="string">'query'</span>][<span class="string">'bool'</span>][<span class="string">'must'</span>] = array_merge($params[<span class="string">'body'</span>][<span class="string">'query'</span>][<span class="string">'bool'</span>][<span class="string">'must'</span>],</span><br><span class="line">                $options[<span class="string">'numericFilters'</span>]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;elastic-&gt;search($params);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Map the given results to instances of the given model.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  mixed  $results</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Database\Eloquent\Model  $model</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Collection</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">map</span><span class="params">(Builder $builder, $results, $model)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ($results[<span class="string">'hits'</span>][<span class="string">'total'</span>] === <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Collection::make();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $keys = collect($results[<span class="string">'hits'</span>][<span class="string">'hits'</span>])</span><br><span class="line">            -&gt;pluck(<span class="string">'_id'</span>)-&gt;values()-&gt;all();</span><br><span class="line"></span><br><span class="line">        $models = $model-&gt;getScoutModelsByIds(</span><br><span class="line">            $builder, $keys</span><br><span class="line">        )-&gt;keyBy(<span class="function"><span class="keyword">function</span> <span class="params">($model)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> $model-&gt;getScoutKey();</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> collect($results[<span class="string">'hits'</span>][<span class="string">'hits'</span>])-&gt;map(<span class="function"><span class="keyword">function</span> <span class="params">($hit)</span> <span class="title">use</span> <span class="params">($model, $models)</span> </span>&#123;</span><br><span class="line">            $one = $models[$hit[<span class="string">'_id'</span>]];</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * 这里返回的数据，如果有 highlight，就把对应的  highlight 设置到对象上面，highlights对应model里定义的属性</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">isset</span>($hit[<span class="string">'highlight'</span>])) &#123;</span><br><span class="line">                $one-&gt;highlights = $hit[<span class="string">'highlight'</span>];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> $one;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="修改Scout的Engine"><a href="#修改Scout的Engine" class="headerlink" title="修改Scout的Engine"></a>修改Scout的Engine</h3><p>config/scout.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'driver'</span> =&gt; env(<span class="string">'SCOUT_DRIVER'</span>, <span class="string">'es'</span>)</span><br></pre></td></tr></table></figure></p><p>app/Providers/AppServiceProvider.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        resolve(EngineManager::class)-&gt;extend(<span class="string">'es'</span>, <span class="function"><span class="keyword">function</span><span class="params">($app)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//实例化EsEngine</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> EsEngine(ElasticBuilder::create()</span><br><span class="line">                -&gt;setHosts(config(<span class="string">'scout.elasticsearch.hosts'</span>))</span><br><span class="line">                -&gt;build(),</span><br><span class="line">                config(<span class="string">'scout.elasticsearch.index'</span>)</span><br><span class="line">            );</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p><h3 id="添加属性trait"><a href="#添加属性trait" class="headerlink" title="添加属性trait"></a>添加属性trait</h3><p>  app/Traits/EsSearchable.php<br>  <strong>traits的拼写，查错查了好久</strong><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Traits</span>;</span><br><span class="line"><span class="keyword">trait</span> EsSearchable</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">//query</span></span><br><span class="line">    <span class="keyword">public</span> $searchSettings = [</span><br><span class="line">        <span class="string">'attributesToHighlight'</span> =&gt; [</span><br><span class="line">            <span class="string">'*'</span></span><br><span class="line">        ]</span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">//store highlight results for blade template</span></span><br><span class="line">    <span class="keyword">public</span> $highlight = [];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="model中添加-EsSearchabel-Trait"><a href="#model中添加-EsSearchabel-Trait" class="headerlink" title="model中添加 EsSearchabel Trait"></a>model中添加 EsSearchabel Trait</h3><p>App/Models/Topic.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Traits</span>\<span class="title">EsSearchabel</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">EsSearchabel</span>;</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p><h3 id="添加关键词的样式"><a href="#添加关键词的样式" class="headerlink" title="添加关键词的样式"></a>添加关键词的样式</h3><p>进入<strong>Tinker</strong><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//结果中带有&lt;em&gt;&lt;/em&gt;标签，对标签设置color属性。</span></span><br><span class="line">$collection = App\Models\Topic::search(<span class="string">"qu"</span>)-&gt;get();</span><br><span class="line">$collection-&gt;first()[<span class="string">'highlights'</span>][<span class="string">'body][0];</span></span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Laravel Scout ElasticSearch搜索的基础上，搜索到的关键词加高亮的效果。&lt;br&gt;参考：&lt;br&gt;&lt;a href=&quot;https://learnku.com/articles/4038/tutorial-two-write-a-search-solve-the-search-results-highlight-the-problem-using-laravel-scout-elasticsearch-ik-word-segmentation&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;搜索结果高亮&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://learnku.com/docs/laravel/5.8/scout/3946&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Scout&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;自定义搜索引擎&quot;&gt;&lt;a href=&quot;#自定义搜索引擎&quot; class=&quot;headerlink&quot; title=&quot;自定义搜索引擎&quot;&gt;&lt;/a&gt;自定义搜索引擎&lt;/h3&gt;
    
    </summary>
    
      <category term="Tech" scheme="http://yoursite.com/categories/Tech/"/>
    
    
      <category term="laravel" scheme="http://yoursite.com/tags/laravel/"/>
    
      <category term="elasticSearch" scheme="http://yoursite.com/tags/elasticSearch/"/>
    
  </entry>
  
  <entry>
    <title>Laravel ElasticSearch Scout</title>
    <link href="http://yoursite.com/2019/05/17/Laravel-ElasticSearch-Scout/"/>
    <id>http://yoursite.com/2019/05/17/Laravel-ElasticSearch-Scout/</id>
    <published>2019-05-17T13:38:01.000Z</published>
    <updated>2019-05-17T23:49:27.738Z</updated>
    
    <content type="html"><![CDATA[<p>Laravel 中使用Elasticsearch 结合Scout,实现全文搜索</p><p>参考:</p><ul><li><a href="https://www.einsition.com/article/7/details" target="_blank" rel="noopener">Laravel Scout+Elastic</a></li><li><a href="https://github.com/ErickTamayo/laravel-scout-elastic" target="_blank" rel="noopener">tamayo/laravel-scout-elastic</a></li></ul><h3 id="安装composer依赖"><a href="#安装composer依赖" class="headerlink" title="安装composer依赖"></a>安装composer依赖</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">composer <span class="keyword">require</span> tamayo/laravel-scout-elastic</span><br><span class="line">composer <span class="keyword">require</span> laravel/scout</span><br></pre></td></tr></table></figure><p>config/app.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'providers'</span> =&gt; [</span><br><span class="line">    ...</span><br><span class="line">    Laravel\Scout\ScoutServiceProvider::class,</span><br><span class="line">    ...</span><br><span class="line">    ScoutEngines\Elasticsearch\ElasticsearchProvider::class,</span><br><span class="line">],</span><br></pre></td></tr></table></figure></p><a id="more"></a><h3 id="配置ElasticSearch"><a href="#配置ElasticSearch" class="headerlink" title="配置ElasticSearch"></a>配置ElasticSearch</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php artisan vendor:publish --provider=<span class="string">"Laravel\Scout\ScoutServiceProvider</span></span><br></pre></td></tr></table></figure><p>config\scout.php配置文件，<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'driver'</span> =&gt; env(<span class="string">'SCOUT_DRIVER'</span>, <span class="string">'elasticsearch'</span>)</span><br></pre></td></tr></table></figure></p><p>.env<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ELASTICSEARCH_INDEX=laravel_index</span><br><span class="line">ELASTICSEARCH_HOST=http:<span class="comment">//localhost</span></span><br></pre></td></tr></table></figure></p><p>config/scout.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//添加elasticsearch配置</span></span><br><span class="line"><span class="string">'elasticsearch'</span> =&gt; [</span><br><span class="line">        <span class="string">'index'</span> =&gt; env(<span class="string">'ELASTICSEARCH_INDEX'</span>, <span class="string">'laravel'</span>),</span><br><span class="line">        <span class="string">'hosts'</span> =&gt; [</span><br><span class="line">            env(<span class="string">'ELASTICSEARCH_HOST'</span>, <span class="string">''</span>),</span><br><span class="line">        ],</span><br><span class="line">    ],</span><br></pre></td></tr></table></figure></p><blockquote><p><strong>Note:</strong> ‘queue’ =&gt; env(‘SCOUT_QUEUE’, false),<br>     不使用queue,php artisan scout:import xxx 能直接看到效果。</p></blockquote><p>  App\Models\Topic.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="comment">//增加Searchable</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">Searchable</span>;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">toSearchableArray</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="keyword">return</span> [</span><br><span class="line">      <span class="string">'title'</span> =&gt; <span class="keyword">$this</span>-&gt;title,</span><br><span class="line">      <span class="string">'content'</span> =&gt; <span class="keyword">$this</span>-&gt;content,</span><br><span class="line">   ];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="创建command-命令"><a href="#创建command-命令" class="headerlink" title="创建command 命令"></a>创建command 命令</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php artisan make:command EsInit</span><br></pre></td></tr></table></figure><p>app\Console\Command\ESInit.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Console</span>\<span class="title">Commands</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">GuzzleHttp</span>\<span class="title">Client</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Console</span>\<span class="title">Command</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ESInit</span> <span class="keyword">extends</span> <span class="title">Command</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * The name and signature of the console command.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@var</span> string</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">protected</span> $signature = <span class="string">'es:init'</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * The console command description.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@var</span> string</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">protected</span> $description = <span class="string">'init laravel es for article'</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Create a new command instance.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">      <span class="keyword">parent</span>::__construct();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Execute the console command.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">(Client $client)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">      <span class="keyword">$this</span>-&gt;createTemplate($client);</span><br><span class="line">      <span class="keyword">$this</span>-&gt;createIndex($client);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 创建模板 see https://www.elastic.co/guide/en/elasticsearch/reference/current/dynamic-templates.html</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> Client $client</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">createTemplate</span><span class="params">(Client $client)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">      $url = config(<span class="string">'scout.elasticsearch.hosts'</span>)[<span class="number">0</span>] . <span class="string">'/_template/template_1'</span>;</span><br><span class="line">      $client-&gt;put($url, [</span><br><span class="line">          <span class="string">'json'</span> =&gt; [</span><br><span class="line">              <span class="string">'template'</span> =&gt; config(<span class="string">'scout.elasticsearch.index'</span>),</span><br><span class="line">              <span class="string">'settings'</span> =&gt; [</span><br><span class="line">                  <span class="string">'number_of_shards'</span> =&gt; <span class="number">1</span>,</span><br><span class="line">              ],</span><br><span class="line">              <span class="string">'mappings'</span> =&gt; [</span><br><span class="line">                  <span class="string">'_default_'</span> =&gt; [</span><br><span class="line">                      <span class="string">'dynamic_templates'</span> =&gt; [ <span class="comment">// 动态映射模板</span></span><br><span class="line">                          [</span><br><span class="line">                              <span class="string">'string_fields'</span> =&gt; [ <span class="comment">// 字段映射模板的名称，一般为"类型_fields"的命名方式</span></span><br><span class="line">                                  <span class="string">'match'</span> =&gt; <span class="string">'*'</span>, <span class="comment">// 匹配的字段名为所有</span></span><br><span class="line">                                  <span class="string">'match_mapping_type'</span> =&gt; <span class="string">'string'</span>, <span class="comment">// 限制匹配的字段类型，只能是 string 类型</span></span><br><span class="line">                                  <span class="string">'mapping'</span> =&gt; [ <span class="comment">// 字段的处理方式</span></span><br><span class="line">                                      <span class="string">'type'</span> =&gt; <span class="string">'text'</span>, <span class="comment">// 字段类型限定为 string</span></span><br><span class="line">                                      <span class="string">'analyzer'</span> =&gt; <span class="string">'ik_smart'</span>, <span class="comment">// 字段采用的分析器名，默认值为 standard 分析器</span></span><br><span class="line">                                      <span class="string">'fields'</span> =&gt; [</span><br><span class="line">                                          <span class="string">'raw'</span> =&gt; [</span><br><span class="line">                                              <span class="string">'type'</span> =&gt; <span class="string">'keyword'</span>,</span><br><span class="line">                                              <span class="string">'ignore_above'</span> =&gt; <span class="number">256</span>, <span class="comment">// 字段是索引时忽略长度超过定义值的字段。</span></span><br><span class="line">                                          ]</span><br><span class="line">                                      ],</span><br><span class="line">                                  ],</span><br><span class="line">                              ],</span><br><span class="line">                          ],</span><br><span class="line">                      ],</span><br><span class="line">                  ],</span><br><span class="line">              ],</span><br><span class="line">          ],</span><br><span class="line">      ]);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">$this</span>-&gt;info(<span class="string">"=======创建模板成功======="</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">createIndex</span><span class="params">(Client $client)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">      $url = config(<span class="string">'scout.elasticsearch.hosts'</span>)[<span class="number">0</span>] . <span class="string">'/'</span> . config(<span class="string">'scout.elasticsearch.index'</span>);</span><br><span class="line"></span><br><span class="line">      $client-&gt;put($url, [</span><br><span class="line">          <span class="string">'json'</span> =&gt; [</span><br><span class="line">              <span class="string">'settings'</span> =&gt; [</span><br><span class="line">                  <span class="string">'refresh_interval'</span> =&gt; <span class="string">'5s'</span>,</span><br><span class="line">                  <span class="string">'number_of_shards'</span> =&gt; <span class="number">1</span>, <span class="comment">// 分片为</span></span><br><span class="line">                  <span class="string">'number_of_replicas'</span> =&gt; <span class="number">0</span>, <span class="comment">// 副本数</span></span><br><span class="line">              ],</span><br><span class="line">              <span class="string">'mappings'</span> =&gt; [</span><br><span class="line">                  <span class="string">'_default_'</span> =&gt; [</span><br><span class="line">                      <span class="string">'_all'</span> =&gt; [</span><br><span class="line">                          <span class="string">'enabled'</span> =&gt; <span class="keyword">false</span>, <span class="comment">// 是否开启所有字段的检索</span></span><br><span class="line">                      ],</span><br><span class="line">                  ],</span><br><span class="line">              ],</span><br><span class="line">          ],</span><br><span class="line">      ]);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">$this</span>-&gt;info(<span class="string">"=========创建索引成功========="</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="执行command导入数据"><a href="#执行command导入数据" class="headerlink" title="执行command导入数据"></a>执行command导入数据</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">php artisan es:init</span><br><span class="line"></span><br><span class="line"><span class="comment">//导入数据</span></span><br><span class="line">php artisan scout:import <span class="string">"App\Models\Topic"</span></span><br></pre></td></tr></table></figure><h3 id="验证template"><a href="#验证template" class="headerlink" title="验证template"></a>验证template</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl localhost:<span class="number">9200</span>/_template/template_1`</span><br><span class="line"></span><br><span class="line">验证导入的数据</span><br><span class="line">curl localhost:<span class="number">9200</span>/laravel_index/_search?pretty</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Laravel 中使用Elasticsearch 结合Scout,实现全文搜索&lt;/p&gt;
&lt;p&gt;参考:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://www.einsition.com/article/7/details&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Laravel Scout+Elastic&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/ErickTamayo/laravel-scout-elastic&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;tamayo/laravel-scout-elastic
&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;安装composer依赖&quot;&gt;&lt;a href=&quot;#安装composer依赖&quot; class=&quot;headerlink&quot; title=&quot;安装composer依赖&quot;&gt;&lt;/a&gt;安装composer依赖&lt;/h3&gt;&lt;figure class=&quot;highlight php&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;composer &lt;span class=&quot;keyword&quot;&gt;require&lt;/span&gt; tamayo/laravel-scout-elastic&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;composer &lt;span class=&quot;keyword&quot;&gt;require&lt;/span&gt; laravel/scout&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;config/app.php&lt;br&gt;&lt;figure class=&quot;highlight php&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;&#39;providers&#39;&lt;/span&gt; =&amp;gt; [&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Laravel\Scout\ScoutServiceProvider::class,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ScoutEngines\Elasticsearch\ElasticsearchProvider::class,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;],&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="Tech" scheme="http://yoursite.com/categories/Tech/"/>
    
    
      <category term="laravel" scheme="http://yoursite.com/tags/laravel/"/>
    
      <category term="elasticSearch" scheme="http://yoursite.com/tags/elasticSearch/"/>
    
      <category term="scout" scheme="http://yoursite.com/tags/scout/"/>
    
  </entry>
  
  <entry>
    <title>Hello World</title>
    <link href="http://yoursite.com/2019/05/17/hello-world/"/>
    <id>http://yoursite.com/2019/05/17/hello-world/</id>
    <published>2019-05-16T23:44:31.952Z</published>
    <updated>2019-05-16T23:44:31.953Z</updated>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><a id="more"></a><p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Welcome to &lt;a href=&quot;https://hexo.io/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Hexo&lt;/a&gt;! This is your very first post. Check &lt;a href=&quot;https://hexo.io/docs/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;documentation&lt;/a&gt; for more info. If you get any problems when using Hexo, you can find the answer in &lt;a href=&quot;https://hexo.io/docs/troubleshooting.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;troubleshooting&lt;/a&gt; or you can ask me on &lt;a href=&quot;https://github.com/hexojs/hexo/issues&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;GitHub&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id=&quot;Quick-Start&quot;&gt;&lt;a href=&quot;#Quick-Start&quot; class=&quot;headerlink&quot; title=&quot;Quick Start&quot;&gt;&lt;/a&gt;Quick Start&lt;/h2&gt;&lt;h3 id=&quot;Create-a-new-post&quot;&gt;&lt;a href=&quot;#Create-a-new-post&quot; class=&quot;headerlink&quot; title=&quot;Create a new post&quot;&gt;&lt;/a&gt;Create a new post&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ hexo new &lt;span class=&quot;string&quot;&gt;&quot;My New Post&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;More info: &lt;a href=&quot;https://hexo.io/docs/writing.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Writing&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;Run-server&quot;&gt;&lt;a href=&quot;#Run-server&quot; class=&quot;headerlink&quot; title=&quot;Run server&quot;&gt;&lt;/a&gt;Run server&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ hexo server&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Laravel websockets</title>
    <link href="http://yoursite.com/2019/05/16/Laravel-websockets/"/>
    <id>http://yoursite.com/2019/05/16/Laravel-websockets/</id>
    <published>2019-05-15T23:00:55.000Z</published>
    <updated>2019-05-17T13:33:37.748Z</updated>
    
    <content type="html"><![CDATA[<p>Laravel 配合laravel-echo 使用 websockets</p><p>参考<br><a href="https://docs.beyondco.de/laravel-websockets/" target="_blank" rel="noopener">Laravel Websockets</a><br><a href="https://learnku.com/docs/laravel/5.8/broadcasting/3914" target="_blank" rel="noopener">广播系统</a><br><a href="https://pusher.com/tutorials/chat-laravel" target="_blank" rel="noopener">Build a chat app with laravel</a><br><a id="more"></a></p><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">composer <span class="keyword">require</span> pusher/pusher-php-server <span class="string">"~3.0"</span></span><br><span class="line">composer <span class="keyword">require</span> beyondcode/laravel-websockets</span><br><span class="line">composer <span class="keyword">require</span> predis/predis</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// a migration to store statistic information</span></span><br><span class="line">php artisan vendor:publish --provider=<span class="string">"BeyondCode\LaravelWebSockets\WebSocketsServiceProvider"</span> --tag=<span class="string">"migrations"</span></span><br><span class="line"></span><br><span class="line">php artisan migrate</span><br><span class="line"></span><br><span class="line"><span class="comment">// publish the WebSocket configuration file</span></span><br><span class="line">php artisan vendor:publish --provider=<span class="string">"BeyondCode\LaravelWebSockets\WebSocketsServiceProvider"</span> --tag=<span class="string">"config"</span></span><br></pre></td></tr></table></figure><p>.env</p><blockquote><p>BROADCAST_DRIVER=pusher<br>QUEUE_CONNECTION=sync //设为sync方便调试,生产环境设为redis</p></blockquote><p>config/broadcasting.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'pusher'</span> =&gt; [</span><br><span class="line">    <span class="string">'driver'</span> =&gt; <span class="string">'pusher'</span>,</span><br><span class="line">    <span class="string">'key'</span> =&gt; env(<span class="string">'PUSHER_APP_KEY'</span>),</span><br><span class="line">    <span class="string">'secret'</span> =&gt; env(<span class="string">'PUSHER_APP_SECRET'</span>),</span><br><span class="line">    <span class="string">'app_id'</span> =&gt; env(<span class="string">'PUSHER_APP_ID'</span>),</span><br><span class="line">    <span class="string">'options'</span> =&gt; [</span><br><span class="line">        <span class="string">'cluster'</span> =&gt; env(<span class="string">'PUSHER_APP_CLUSTER'</span>),</span><br><span class="line">        <span class="string">'encrypted'</span> =&gt; <span class="keyword">true</span>,</span><br><span class="line">        <span class="string">'host'</span> =&gt; <span class="string">'127.0.0.1'</span>,</span><br><span class="line">        <span class="string">'port'</span> =&gt; <span class="number">6001</span>,</span><br><span class="line">        <span class="string">'scheme'</span> =&gt; <span class="string">'http'</span></span><br><span class="line">    ],</span><br><span class="line">],</span><br></pre></td></tr></table></figure></p><p>config/app.php</p><blockquote><p>App\Providers\BroadcastServiceProvider::class,</p></blockquote><p><strong>取消注释,否则auth/broadcasting not found 错误</strong></p><h3 id="后端部分"><a href="#后端部分" class="headerlink" title="后端部分"></a>后端部分</h3><blockquote><p>php artisan make:event ExampleEvent</p></blockquote><p>App\Events\ExampleEvent.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Events</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Message</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">User</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Broadcasting</span>\<span class="title">Channel</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Queue</span>\<span class="title">SerializesModels</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Broadcasting</span>\<span class="title">PrivateChannel</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Broadcasting</span>\<span class="title">PresenceChannel</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Events</span>\<span class="title">Dispatchable</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Broadcasting</span>\<span class="title">InteractsWithSockets</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">Broadcasting</span>\<span class="title">ShouldBroadcast</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MessageSent</span> <span class="keyword">implements</span> <span class="title">ShouldBroadcast</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">Dispatchable</span>, <span class="title">InteractsWithSockets</span>, <span class="title">SerializesModels</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create a new event instance.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $user;</span><br><span class="line">    <span class="keyword">public</span> $message;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(User $user,Message $message)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;user = $user;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;message = $message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the channels the event should broadcast on.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> \Illuminate\Broadcasting\Channel|array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">broadcastOn</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> PrivateChannel(<span class="string">'chat'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>routes/channel.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Broadcast::channel(<span class="string">'chat'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($user)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> \Auth::check();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p><p>使用laravel login 脚手架<br>php artisan make:auth<br><code>protected $redirectTo = &#39;/&#39;;</code><br><strong>Auth/RegisterController,Auth/LoginController Auth/ResetPasswordController</strong></p><p>routes/web.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Auth::routes();</span><br><span class="line"></span><br><span class="line">Route::get(<span class="string">'/'</span>, <span class="string">'ChatsController@index'</span>);</span><br><span class="line">Route::get(<span class="string">'messages'</span>, <span class="string">'ChatsController@fetchMessages'</span>);</span><br><span class="line">Route::post(<span class="string">'messages'</span>, <span class="string">'ChatsController@sendMessage'</span>);</span><br></pre></td></tr></table></figure></p><blockquote><p>php artisan make:controller ChatsController</p></blockquote><p>Controllers/ChatsController<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Events</span>\<span class="title">MessageSent</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Message</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Auth</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChatsController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;middleware(<span class="string">'auth'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> view(<span class="string">'chat'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Message</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">fetchMessages</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Message::with(<span class="string">'user'</span>)-&gt;get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> Request $request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sendMessage</span><span class="params">(Request $request)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $user = Auth::user();</span><br><span class="line"></span><br><span class="line">        $message = $user-&gt;messages()-&gt;create([</span><br><span class="line">           <span class="string">'message'</span>=&gt;$request-&gt;input(<span class="string">'message'</span>)</span><br><span class="line">        ]);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//只广播给其他人</span></span><br><span class="line">        broadcast(<span class="keyword">new</span> MessageSent($user,$message))-&gt;toOthers();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> [<span class="string">'status'</span>=&gt;<span class="string">'Message sent!'</span>];</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="安装前端依赖"><a href="#安装前端依赖" class="headerlink" title="安装前端依赖"></a>安装前端依赖</h3><blockquote><p>npm install –save laravel-echo pusher-js</p></blockquote><p>bootstrap.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Echo <span class="keyword">from</span> <span class="string">"laravel-echo"</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">window</span>.Pusher = <span class="built_in">require</span>(<span class="string">'pusher-js'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">window</span>.Echo = <span class="keyword">new</span> Echo(&#123;</span><br><span class="line">    broadcaster: <span class="string">'pusher'</span>,</span><br><span class="line">    key: <span class="string">'b540cc10ff9a76b8ee18'</span>, <span class="comment">//your pusher key</span></span><br><span class="line">    wsHost: <span class="built_in">window</span>.location.hostname,</span><br><span class="line">    wsPort: <span class="number">6001</span>,</span><br><span class="line">    disableStats: <span class="literal">true</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p><p>app.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.Echo.private(<span class="string">'chat'</span>)</span><br><span class="line">            .listen(<span class="string">'MessageSent'</span>,(e)=&gt;&#123;</span><br><span class="line">               <span class="keyword">this</span>.messages.push(&#123;</span><br><span class="line">                    message: e.message.message,</span><br><span class="line">                    user: e.user</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;);</span><br></pre></td></tr></table></figure></p><p>增加wsHost,wsPort 指向Laravel WebSocket server。</p><blockquote><p>npm run watch</p></blockquote><p>编译css,js</p><h3 id="启动WebSocket-server"><a href="#启动WebSocket-server" class="headerlink" title="启动WebSocket server"></a>启动WebSocket server</h3><blockquote><p>php artisan websockets:serve</p></blockquote><h3 id="Debugging"><a href="#Debugging" class="headerlink" title="Debugging"></a>Debugging</h3><p><a href="http://tasks.test/laravel-websockets" target="_blank" rel="noopener">http://tasks.test/laravel-websockets</a></p><p>总结：<br>1.后端生成事件，依赖注入要发送的对象。<br>2.使用broadcast()方法广播事件<br>3.前端Echo接收频道以及频道的特定事件。</p><p>Note:</p><ul><li>使用队列处理事件，启动php artisan queue:work,调试的时候QUEUE_DRIVER= sync</li><li>前端更改代码，npm run watch，刷新后看到效果</li><li>App\Providers\BroadcastServiceProvider::class要取消注释。</li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Laravel 配合laravel-echo 使用 websockets&lt;/p&gt;
&lt;p&gt;参考&lt;br&gt;&lt;a href=&quot;https://docs.beyondco.de/laravel-websockets/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Laravel Websockets&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://learnku.com/docs/laravel/5.8/broadcasting/3914&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;广播系统&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://pusher.com/tutorials/chat-laravel&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Build a chat app with laravel&lt;/a&gt;&lt;br&gt;
    
    </summary>
    
      <category term="Tech" scheme="http://yoursite.com/categories/Tech/"/>
    
    
      <category term="laravel" scheme="http://yoursite.com/tags/laravel/"/>
    
      <category term="websockets" scheme="http://yoursite.com/tags/websockets/"/>
    
  </entry>
  
</feed>
