<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Scott Blog</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2020-04-20T13:08:37.188Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>Scott Shen</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Laravel Api Resource</title>
    <link href="http://yoursite.com/2020/04/19/Resource/"/>
    <id>http://yoursite.com/2020/04/19/Resource/</id>
    <published>2020-04-19T09:21:40.000Z</published>
    <updated>2020-04-20T13:08:37.188Z</updated>
    
    <content type="html"><![CDATA[<p>Laravel 不使用第三方包，实现 API 功能。</p><p>参考：</p><ul><li><a href="https://learnku.com/docs/laravel/7.x/eloquent-resources/7503#78699b" target="_blank" rel="noopener">Laravel API资源</a></li><li><a href="https://learnku.com/courses/laravel-advance-training/6.x/list-of-posts/5722" target="_blank" rel="noopener">Include机制</a></li><li><a href="https://learnku.com/docs/laravel/7.x/eloquent-relationships/7500#eager-loading" target="_blank" rel="noopener">预加载</a></li></ul><h2 id="生成资源"><a href="#生成资源" class="headerlink" title="生成资源"></a>生成资源</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成 User资源</span></span><br><span class="line">php artisan make:resource User</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成 User资源集合</span></span><br><span class="line">php artisan make:resource UserCollection</span><br></pre></td></tr></table></figure><p><em>app/Http/Resources/User.php</em><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Resources</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Resources</span>\<span class="title">Json</span>\<span class="title">JsonResource</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Resources</span>\<span class="title">Book</span> <span class="title">as</span> <span class="title">BookResource</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">JsonResource</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Transform the resource into an array.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Http\Request  $request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">toArray</span><span class="params">($request)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    <span class="comment">// $this 代表 User 实例</span></span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            <span class="string">'id'</span> =&gt; <span class="keyword">$this</span>-&gt;id,</span><br><span class="line">            <span class="string">'name'</span> =&gt; <span class="keyword">$this</span>-&gt;name,</span><br><span class="line">            <span class="string">'email'</span> =&gt; <span class="keyword">$this</span>-&gt;phone,</span><br><span class="line">            </span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><a id="more"></a><h2 id="资源的使用"><a href="#资源的使用" class="headerlink" title="资源的使用"></a>资源的使用</h2><p><em>routes/api.php</em></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">// new UserResource（）包裹查询结果</span></span><br><span class="line">Route::get(<span class="string">'/info/'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> UserResource(App\Models\User::find(<span class="number">1</span>));</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gdz8pz15vdj30q208owef.jpg" alt="单个资源"><br><strong>单个资源</strong></p><h2 id="资源集合的使用"><a href="#资源集合的使用" class="headerlink" title="资源集合的使用"></a>资源集合的使用</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line">Route::get(<span class="string">'/user'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> UserResource::collection(User::all());</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义的资源集合 UserCollection</span></span><br><span class="line">Route::get(<span class="string">'/users'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> UserCollection(User::all());</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="自定义资源集合"><a href="#自定义资源集合" class="headerlink" title="自定义资源集合"></a>自定义资源集合</h3><p><em>app/Http/Resources/BookCollection.php</em><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">namespace App\Http\Resources;</span><br><span class="line"></span><br><span class="line">use Illuminate\Http\Resources\Json\ResourceCollection;</span><br><span class="line"></span><br><span class="line">class BookCollection extends ResourceCollection</span><br><span class="line">&#123;</span><br><span class="line">    /**</span><br><span class="line">     * Transform the resource collection into an array.</span><br><span class="line">     *</span><br><span class="line">     * @param  \Illuminate\Http\Request  $request</span><br><span class="line">     * @return array</span><br><span class="line">     */</span><br><span class="line">    public function toArray($request)</span><br><span class="line">    &#123;</span><br><span class="line">        return [</span><br><span class="line">            &apos;data&apos;=&gt;$this-&gt;collection,</span><br><span class="line">            &apos;link&apos;=&gt;&apos;link-value&apos;</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gdz8sv2rvjj30h806yt8j.jpg" alt><br><strong>自定义资源集合</strong></p><h2 id="资源关联"><a href="#资源关联" class="headerlink" title="资源关联"></a>资源关联</h2><h3 id="直接关联"><a href="#直接关联" class="headerlink" title="直接关联"></a>直接关联</h3><blockquote><p>User和Book关联，一个读者有多本书。</p></blockquote><p><em>app/Models/User.php</em><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">books</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;hasMany(Book::class);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p><p><em>app/Http/Resources/User.php</em></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">toArray</span><span class="params">($request)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            <span class="string">'id'</span> =&gt; <span class="keyword">$this</span>-&gt;id,</span><br><span class="line">            <span class="string">'name'</span> =&gt; <span class="keyword">$this</span>-&gt;name,</span><br><span class="line">            <span class="string">'email'</span> =&gt; <span class="keyword">$this</span>-&gt;phone,</span><br><span class="line">            <span class="string">'book'</span>=&gt;BookResource::collection(<span class="keyword">$this</span>-&gt;books),</span><br><span class="line"></span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><em>routes/api.php</em><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line">Route::get(<span class="string">'/info/related'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> UserResource(App\Models\User::find(<span class="number">1</span>));</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p><p>关联的操作放在 Resource中完成，路由中没有参与。</p><h3 id="条件关联"><a href="#条件关联" class="headerlink" title="条件关联"></a>条件关联</h3><p><em>app/Http/Resources/User.php</em></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">toArray</span><span class="params">($request)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            <span class="string">'id'</span> =&gt; <span class="keyword">$this</span>-&gt;id,</span><br><span class="line">            <span class="string">'name'</span> =&gt; <span class="keyword">$this</span>-&gt;name,</span><br><span class="line">            <span class="string">'email'</span> =&gt; <span class="keyword">$this</span>-&gt;phone,</span><br><span class="line">            <span class="string">'book'</span>=&gt;BookResource::collection(<span class="keyword">$this</span>-&gt;whenLoaded(<span class="string">'books'</span>)),</span><br><span class="line"></span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><em>routes/api.php</em><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line">Route::get(<span class="string">'/info/condition'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> UserResource(App\Models\User::find(<span class="number">1</span>)-&gt;load(<span class="string">'books'</span>));</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p><p>关联的操作路由和 Resource中都有出现。路由中<strong>取消</strong>load(‘books’),响应中不会出现book数据，符合条件关联。</p><h2 id="Include机制"><a href="#Include机制" class="headerlink" title="Include机制"></a>Include机制</h2><blockquote><p>如果客户端只是显示一下所有话题的标题，但是接口却返回了所有相关的数据，不仅做了额外的查询，还增加了响应的数据.<br>最好的做法应该是<strong>客户端想要什么，我们就返回什么资源</strong>的数据，客户端应该提供参数，告诉接口是否需要相关的其他资源。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ composer require spatie/laravel-query-builder</span><br></pre></td></tr></table></figure><h3 id="扩展包的使用"><a href="#扩展包的使用" class="headerlink" title="扩展包的使用"></a>扩展包的使用</h3><blockquote><p>扩展包针对的是资源集合。</p></blockquote><p><em>app/Http/Controllers/Api/UsersController.php</em><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Api</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Models</span>\<span class="title">User</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Spatie</span>\<span class="title">QueryBuilder</span>\<span class="title">QueryBuilder</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Spatie</span>\<span class="title">QueryBuilder</span>\<span class="title">AllowedFilter</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Resources</span>\<span class="title">User</span> <span class="title">as</span> <span class="title">UserResource</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UsersController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"><span class="comment">// allowedIncludes('books') model中定义的books()方法。</span></span><br><span class="line"><span class="comment">// allowedFilters过滤器，例如 ’name'，模糊搜索对应的 name值</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $users = QueryBuilder::for(User::class)</span><br><span class="line">            -&gt;allowedIncludes(<span class="string">'books'</span>)</span><br><span class="line">             -&gt;allowedFilters([</span><br><span class="line">                <span class="string">'name'</span></span><br><span class="line">            ])</span><br><span class="line">            -&gt;paginate();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> UserResource::collection($users);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><em>app/Http/Resources/User.php</em></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Resources</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Resources</span>\<span class="title">Json</span>\<span class="title">JsonResource</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Resources</span>\<span class="title">Book</span> <span class="title">as</span> <span class="title">BookResource</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">JsonResource</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Transform the resource into an array.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Http\Request  $request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">toArray</span><span class="params">($request)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            <span class="string">'id'</span> =&gt; <span class="keyword">$this</span>-&gt;id,</span><br><span class="line">            <span class="string">'name'</span> =&gt; <span class="keyword">$this</span>-&gt;name,</span><br><span class="line">            <span class="string">'email'</span> =&gt; <span class="keyword">$this</span>-&gt;phone,</span><br><span class="line">            <span class="comment">// 条件关联</span></span><br><span class="line">            <span class="string">'book'</span>=&gt;BookResource::collection(<span class="keyword">$this</span>-&gt;whenLoaded(<span class="string">'books'</span>))</span><br><span class="line"></span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><em>routes/api.php</em><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line">Route::namespace(<span class="string">'Api'</span>)-&gt;group(<span class="function"><span class="keyword">function</span> <span class="params">()</span></span>&#123;</span><br><span class="line">    Route::get(<span class="string">'/users/'</span>,<span class="string">'UsersController@index'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p><p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ge0j6v26gzj30xc0u0wfa.jpg" alt><br>Include机制</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Laravel 不使用第三方包，实现 API 功能。&lt;/p&gt;
&lt;p&gt;参考：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://learnku.com/docs/laravel/7.x/eloquent-resources/7503#78699b&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Laravel API资源&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://learnku.com/courses/laravel-advance-training/6.x/list-of-posts/5722&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Include机制&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://learnku.com/docs/laravel/7.x/eloquent-relationships/7500#eager-loading&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;预加载&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;生成资源&quot;&gt;&lt;a href=&quot;#生成资源&quot; class=&quot;headerlink&quot; title=&quot;生成资源&quot;&gt;&lt;/a&gt;生成资源&lt;/h2&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 生成 User资源&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;php artisan make:resource User&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# 生成 User资源集合&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;php artisan make:resource UserCollection&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;em&gt;app/Http/Resources/User.php&lt;/em&gt;&lt;br&gt;&lt;figure class=&quot;highlight php&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;26&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;27&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;&amp;lt;?php&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;namespace&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;App&lt;/span&gt;\&lt;span class=&quot;title&quot;&gt;Http&lt;/span&gt;\&lt;span class=&quot;title&quot;&gt;Resources&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;Illuminate&lt;/span&gt;\&lt;span class=&quot;title&quot;&gt;Http&lt;/span&gt;\&lt;span class=&quot;title&quot;&gt;Resources&lt;/span&gt;\&lt;span class=&quot;title&quot;&gt;Json&lt;/span&gt;\&lt;span class=&quot;title&quot;&gt;JsonResource&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;App&lt;/span&gt;\&lt;span class=&quot;title&quot;&gt;Http&lt;/span&gt;\&lt;span class=&quot;title&quot;&gt;Resources&lt;/span&gt;\&lt;span class=&quot;title&quot;&gt;Book&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;as&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;BookResource&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;User&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;JsonResource&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;class&quot;&gt;&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;/**&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;     * Transform the resource into an array.&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;     *&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;     * &lt;span class=&quot;doctag&quot;&gt;@param&lt;/span&gt;  \Illuminate\Http\Request  $request&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;     * &lt;span class=&quot;doctag&quot;&gt;@return&lt;/span&gt; array&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;     */&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;toArray&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;($request)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;    &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;// $this 代表 User 实例&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; [&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;string&quot;&gt;&#39;id&#39;&lt;/span&gt; =&amp;gt; &lt;span class=&quot;keyword&quot;&gt;$this&lt;/span&gt;-&amp;gt;id,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;string&quot;&gt;&#39;name&#39;&lt;/span&gt; =&amp;gt; &lt;span class=&quot;keyword&quot;&gt;$this&lt;/span&gt;-&amp;gt;name,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;span class=&quot;string&quot;&gt;&#39;email&#39;&lt;/span&gt; =&amp;gt; &lt;span class=&quot;keyword&quot;&gt;$this&lt;/span&gt;-&amp;gt;phone,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;            &lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        ];&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="Tech" scheme="http://yoursite.com/categories/Tech/"/>
    
    
      <category term="laravel" scheme="http://yoursite.com/tags/laravel/"/>
    
      <category term="api" scheme="http://yoursite.com/tags/api/"/>
    
  </entry>
  
  <entry>
    <title>LinkedList</title>
    <link href="http://yoursite.com/2019/12/19/LinkedList/"/>
    <id>http://yoursite.com/2019/12/19/LinkedList/</id>
    <published>2019-12-19T13:25:34.000Z</published>
    <updated>2019-12-19T14:00:43.975Z</updated>
    
    <content type="html"><![CDATA[<p>LinkedList 使用快慢指针寻找链表的中点,遍历一遍链表。<br>参考链接：</p><ul><li><a href="https://www.geeksforgeeks.org/write-a-c-function-to-print-the-middle-of-the-linked-list/" target="_blank" rel="noopener">middle-of-the-linked-list</a></li></ul><p><img src="https://media.geeksforgeeks.org/wp-content/cdn-uploads/20190621135246/Find-the-middle-of-a-given-linked-list-in-C-and-Java14.png" alt="快慢指针"><br><a id="more"></a><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Java program to find middle of linked list</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LinkedList</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    Node head; <span class="comment">// head of linked list</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Linked list node */</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Node</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> data;</span><br><span class="line">        Node next;</span><br><span class="line">        Node(<span class="keyword">int</span> d)</span><br><span class="line">        &#123;</span><br><span class="line">            data = d;</span><br><span class="line">            next = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Function to print middle of linked list */</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * 快慢指针，同时开跑，快指针的速度是慢指针的2倍</span></span><br><span class="line"><span class="comment">    * 快指针到达终点时，慢指针到达中间</span></span><br><span class="line"><span class="comment">    * 长度为奇数，有中间节点；</span></span><br><span class="line"><span class="comment">    * 长度为偶数，中间节点 len/2+1</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">printMiddle</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Node slow_ptr = head;</span><br><span class="line">        Node fast_ptr = head;</span><br><span class="line">        <span class="keyword">if</span> (head != <span class="keyword">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// fast &amp;&amp; fast.next不为 null,</span></span><br><span class="line">            <span class="comment">// null.next会报错。</span></span><br><span class="line">            <span class="keyword">while</span> (fast_ptr != <span class="keyword">null</span> &amp;&amp; fast_ptr.next != <span class="keyword">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                fast_ptr = fast_ptr.next.next;</span><br><span class="line">                slow_ptr = slow_ptr.next;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">"The middle element is ["</span> +</span><br><span class="line">                    slow_ptr.data + <span class="string">"] \n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Inserts a new Node at front of the list. */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">push</span><span class="params">(<span class="keyword">int</span> new_data)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"><span class="comment">/* 1 &amp; 2: Allocate the Node &amp;</span></span><br><span class="line"><span class="comment">Put in the data*/</span></span><br><span class="line">        Node new_node = <span class="keyword">new</span> Node(new_data);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 3. Make next of new Node as head */</span></span><br><span class="line">        new_node.next = head;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 4. Move the head to point to new Node */</span></span><br><span class="line">        head = new_node;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* This function prints contents of linked list</span></span><br><span class="line"><span class="comment">    starting from the given node */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printList</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Node tnode = head;</span><br><span class="line">        <span class="keyword">while</span> (tnode != <span class="keyword">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            System.out.print(tnode.data+<span class="string">"-&gt;"</span>);</span><br><span class="line">            tnode = tnode.next;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"NULL"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String [] args)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        LinkedList llist = <span class="keyword">new</span> LinkedList();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">5</span>; i&gt;<span class="number">0</span>; --i)</span><br><span class="line">        &#123;</span><br><span class="line">            llist.push(i);</span><br><span class="line">            llist.printList();</span><br><span class="line">            llist.printMiddle();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><strong>运行结果：</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">5-&gt;NULL</span><br><span class="line">The middle element is [5] </span><br><span class="line"></span><br><span class="line">4-&gt;5-&gt;NULL</span><br><span class="line">The middle element is [5] </span><br><span class="line"></span><br><span class="line">3-&gt;4-&gt;5-&gt;NULL</span><br><span class="line">The middle element is [4] </span><br><span class="line"></span><br><span class="line">2-&gt;3-&gt;4-&gt;5-&gt;NULL</span><br><span class="line">The middle element is [4] </span><br><span class="line"></span><br><span class="line">1-&gt;2-&gt;3-&gt;4-&gt;5-&gt;NULL</span><br><span class="line">The middle element is [3]</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;LinkedList 使用快慢指针寻找链表的中点,遍历一遍链表。&lt;br&gt;参考链接：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://www.geeksforgeeks.org/write-a-c-function-to-print-the-middle-of-the-linked-list/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;middle-of-the-linked-list&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&quot;https://media.geeksforgeeks.org/wp-content/cdn-uploads/20190621135246/Find-the-middle-of-a-given-linked-list-in-C-and-Java14.png&quot; alt=&quot;快慢指针&quot;&gt;&lt;br&gt;
    
    </summary>
    
      <category term="Tech" scheme="http://yoursite.com/categories/Tech/"/>
    
    
      <category term="algorithm" scheme="http://yoursite.com/tags/algorithm/"/>
    
      <category term="linkedlist" scheme="http://yoursite.com/tags/linkedlist/"/>
    
  </entry>
  
  <entry>
    <title>vue.js</title>
    <link href="http://yoursite.com/2019/12/09/vue-js/"/>
    <id>http://yoursite.com/2019/12/09/vue-js/</id>
    <published>2019-12-08T23:24:48.000Z</published>
    <updated>2019-12-10T23:19:08.724Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Laravel-with-Vue-js"><a href="#Laravel-with-Vue-js" class="headerlink" title="Laravel with Vue.js"></a>Laravel with Vue.js</h1><p>参考链接：</p><ul><li><a href="https://learnku.com/laravel/t/34858" target="_blank" rel="noopener">通过 Laravel 创建一个 Vue 单页面应用</a></li><li><a href="https://router.vuejs.org/zh/guide/essentials/navigation.html" target="_blank" rel="noopener">Vue-router</a></li></ul><p>Laravel中使用vue.js实现前后端分离。Laravel 后端只提供 api供 Vue.js 前端调用。</p><h2 id="Laravel-配置"><a href="#Laravel-配置" class="headerlink" title="Laravel 配置"></a>Laravel 配置</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ laravel new todo</span><br></pre></td></tr></table></figure><p><strong>项目的入口 spa 视图</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ php artisan make:controller SpaController</span><br></pre></td></tr></table></figure></p><p><em>Http/Controllers/SpaController.php</em><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SpaController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">// 项目的入口</span></span><br><span class="line">        <span class="keyword">return</span> view(<span class="string">'spa'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><a id="more"></a><h3 id="配置入口路由"><a href="#配置入口路由" class="headerlink" title="配置入口路由"></a>配置入口路由</h3><p><em>routes/web.php</em><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// where()使用正则表达式匹配，.* 代表任何url都会被匹配</span></span><br><span class="line">Route::get(<span class="string">'/&#123;any&#125;'</span>, <span class="string">'SpaController@index'</span>)-&gt;where(<span class="string">'any'</span>, <span class="string">'.*'</span>);</span><br></pre></td></tr></table></figure></p><h3 id="入口视图-spa"><a href="#入口视图-spa" class="headerlink" title="入口视图 spa"></a>入口视图 spa</h3><p><em>resources/views/spa.blade.php</em><br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"ie=edge"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Vue SPA Demo<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">app</span>&gt;</span><span class="tag">&lt;/<span class="name">app</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;&#123; mix('js/app.js') &#125;&#125;"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p><em>resources/js/app.js</em><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'vue'</span></span><br><span class="line"><span class="keyword">import</span> VueRouter <span class="keyword">from</span> <span class="string">'vue-router'</span></span><br><span class="line"></span><br><span class="line">Vue.use(VueRouter);</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">'./views/App'</span></span><br><span class="line"><span class="keyword">import</span> Hello <span class="keyword">from</span> <span class="string">'./views/Hello'</span></span><br><span class="line"><span class="keyword">import</span> Home <span class="keyword">from</span> <span class="string">'./views/Home'</span></span><br><span class="line"><span class="keyword">import</span> UsersIndex <span class="keyword">from</span> <span class="string">"./views/UsersIndex"</span>;</span><br><span class="line"><span class="keyword">import</span> UsersEdit <span class="keyword">from</span> <span class="string">"./views/UsersEdit"</span>;</span><br><span class="line"><span class="keyword">import</span> NotFound <span class="keyword">from</span> <span class="string">"./views/NotFound"</span></span><br><span class="line"><span class="keyword">import</span> UsersCreate <span class="keyword">from</span> <span class="string">"./views/UsersCreate"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> VueRouter(&#123;</span><br><span class="line">    mode: <span class="string">'history'</span>,</span><br><span class="line">    routes: [</span><br><span class="line">        &#123;</span><br><span class="line">            path: <span class="string">'/'</span>,</span><br><span class="line">            name: <span class="string">'home'</span>,</span><br><span class="line">            component: Home</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            path: <span class="string">'/hello'</span>,</span><br><span class="line">            name: <span class="string">'hello'</span>,</span><br><span class="line">            component: Hello,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            path: <span class="string">'/users'</span>,</span><br><span class="line">            name: <span class="string">'users.index'</span>,</span><br><span class="line">            component: UsersIndex,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            path: <span class="string">'/users/:id/edit'</span>,</span><br><span class="line">            name: <span class="string">'users.edit'</span>,</span><br><span class="line">            component: UsersEdit,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            path: <span class="string">'/users/create'</span>,</span><br><span class="line">            name: <span class="string">'users.create'</span>,</span><br><span class="line">            component: UsersCreate,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            path: <span class="string">'/404'</span>,</span><br><span class="line">            name: <span class="string">'404'</span>,</span><br><span class="line">            component: NotFound,</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            path: <span class="string">'*'</span>,</span><br><span class="line">            redirect: <span class="string">'/404'</span></span><br><span class="line">        &#125;,</span><br><span class="line">    ],</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">    el: <span class="string">'#app'</span>,</span><br><span class="line">    components: &#123; App &#125;,</span><br><span class="line">    router,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p><p><em>resources/js/views/App.vue</em><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">        &lt;h1&gt;Vue Router Demo App&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">        &lt;p&gt;</span></span><br><span class="line"><span class="regexp">            &lt;router-link :to="&#123; name: 'home' &#125;"&gt;Home&lt;/</span>router-link&gt; |</span><br><span class="line">            &lt;router-link :to=<span class="string">"&#123; name: 'hello' &#125;"</span>&gt;Hello World&lt;<span class="regexp">/router-link&gt;</span></span><br><span class="line"><span class="regexp">            &lt;router-link :to="&#123; name: 'users.index' &#125;"&gt;Users&lt;/</span>router-link&gt;</span><br><span class="line">        &lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">        &lt;div class="container"&gt;</span></span><br><span class="line"><span class="regexp">            &lt;router-view&gt;&lt;/</span>router-view&gt;</span><br><span class="line">        &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>div&gt;</span><br><span class="line">&lt;<span class="regexp">/template&gt;</span></span><br><span class="line"><span class="regexp">&lt;script&gt;</span></span><br><span class="line"><span class="regexp">    export default &#123;&#125;</span></span><br><span class="line"><span class="regexp">&lt;/</span>script&gt;</span><br></pre></td></tr></table></figure></p><h2 id="显示所有用户"><a href="#显示所有用户" class="headerlink" title="显示所有用户"></a>显示所有用户</h2><h3 id="用户数据填充"><a href="#用户数据填充" class="headerlink" title="用户数据填充"></a>用户数据填充</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ php artisan make:seeder UsersTableSeeder</span><br></pre></td></tr></table></figure><p><em>database/seeds/UsersTableSeeder.php</em><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Seeder</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UsersTableSeeder</span> <span class="keyword">extends</span> <span class="title">Seeder</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Run the database seeds.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        factory(App\User::class, <span class="number">50</span>)-&gt;create();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><em>database/seeds/DatabaseSeeder.php</em><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Seeder</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DatabaseSeeder</span> <span class="keyword">extends</span> <span class="title">Seeder</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Seed the application's database.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;call([</span><br><span class="line">            UsersTableSeeder::class,</span><br><span class="line">        ]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ php artisan migrate:refresh --seed</span><br></pre></td></tr></table></figure><h3 id="Users-控制器"><a href="#Users-控制器" class="headerlink" title="Users 控制器"></a>Users 控制器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ php artisan make:controller Api/UsersController</span><br><span class="line">$ php artisan make:resource UserResource</span><br></pre></td></tr></table></figure><p><em>routes/api.php</em><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">Route::namespace(<span class="string">'Api'</span>)-&gt;group(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    Route::get(<span class="string">'/users'</span>, <span class="string">'UsersController@index'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p><p><em>app/Http/Controllers/Api/UsersController.php</em><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Api</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Controller</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">User</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Resources</span>\<span class="title">UserResource</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UsersController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> UserResource::collection(User::paginate(<span class="number">10</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">show</span><span class="params">(User $user)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> UserResource($user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">update</span><span class="params">(User $user,Request $request)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $data = $request-&gt;validate([</span><br><span class="line">           <span class="string">'name'</span> =&gt; <span class="string">'required'</span>,</span><br><span class="line">            <span class="string">'email'</span> =&gt; <span class="string">'required|email'</span>,</span><br><span class="line">        ]);</span><br><span class="line"></span><br><span class="line">        $user-&gt;update($data);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> UserResource($user);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">destroy</span><span class="params">(User $user)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $user-&gt;delete();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> response(<span class="keyword">null</span>, <span class="number">204</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">store</span><span class="params">(Request $request)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $data = $request-&gt;validate([</span><br><span class="line">            <span class="string">'name'</span> =&gt; <span class="string">'required'</span>,</span><br><span class="line">            <span class="string">'email'</span> =&gt; <span class="string">'required|unique:users'</span>,</span><br><span class="line">            <span class="string">'password'</span> =&gt; <span class="string">'required|min:8'</span>,</span><br><span class="line">        ]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> UserResource(User::create([</span><br><span class="line">            <span class="string">'name'</span> =&gt; $data[<span class="string">'name'</span>],</span><br><span class="line">            <span class="string">'email'</span> =&gt; $data[<span class="string">'email'</span>],</span><br><span class="line">            <span class="string">'password'</span> =&gt; bcrypt($data[<span class="string">'password'</span>]),</span><br><span class="line">        ]));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="UserIndex-vue-前端文件"><a href="#UserIndex-vue-前端文件" class="headerlink" title="UserIndex.vue 前端文件"></a>UserIndex.vue 前端文件</h3><p><strong>Vue-router</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// 命名的路由</span><br><span class="line">router.push(&#123; name: &apos;user&apos;, params: &#123; userId: &apos;123&apos; &#125;&#125;)</span><br><span class="line"></span><br><span class="line">router.push(&#123; name: &apos;user&apos;, params: &#123; userId &#125;&#125;) // -&gt; /user/123</span><br><span class="line"></span><br><span class="line">// 带查询参数，变成 /register?plan=private</span><br><span class="line">router.push(&#123; path: &apos;register&apos;, query: &#123; plan: &apos;private&apos; &#125;&#125;)</span><br></pre></td></tr></table></figure></p><p>分页的数据结构<br><img src="https://tva1.sinaimg.cn/large/006tNbRwgy1g9seygtq94j30ss0kuwex.jpg" alt="分页数据结构"></p><p><em>resources/js/views/UsersIndex.vue</em><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;div class="users"&gt;</span><br><span class="line">        &lt;div v-if="error" class="error"&gt;</span><br><span class="line">            &lt;p&gt;&#123;&#123; error &#125;&#125;&lt;/p&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">        &lt;ul v-<span class="keyword">if</span>=<span class="string">"users"</span>&gt;</span><br><span class="line">            &lt;li v-<span class="keyword">for</span>=<span class="string">"&#123; id ,name, email &#125; in users"</span>&gt;</span><br><span class="line">                &lt;strong&gt;Name:&lt;/strong&gt; &#123;&#123; name &#125;&#125;,</span><br><span class="line">                &lt;strong&gt;Email:&lt;/strong&gt; &#123;&#123; email &#125;&#125;</span><br><span class="line">                &lt;router-link :to=<span class="string">"&#123; name: 'users.edit',params: &#123;id&#125; &#125;"</span>&gt;Edit&lt;/router-link&gt;</span><br><span class="line">            &lt;/li&gt;</span><br><span class="line">        &lt;/ul&gt;</span><br><span class="line"></span><br><span class="line">        &lt;div class="pagination"&gt;</span><br><span class="line">            &lt;button :disabled=<span class="string">"! prevPage"</span> @click.prevent=<span class="string">"goToPrev"</span>&gt;Previous&lt;/button&gt;</span><br><span class="line">            &#123;&#123; paginatonCount &#125;&#125;</span><br><span class="line">            &lt;button :disabled=<span class="string">"! nextPage"</span> @click.prevent=<span class="string">"goToNext"</span>&gt;Next&lt;/button&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">        &lt;div&gt;</span><br><span class="line">            &lt;router-link :to=<span class="string">"&#123; name: 'users.create' &#125;"</span>&gt;Add User&lt;/router-link&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    import axios from <span class="string">'axios'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> getUsers = (page,callback)=&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> params = &#123; page &#125;;</span><br><span class="line"></span><br><span class="line">        axios</span><br><span class="line">            .get(<span class="string">'/api/users'</span>,&#123;params&#125;)</span><br><span class="line">            .then(response =&gt; &#123;</span><br><span class="line">                callback(<span class="keyword">null</span>, response.data);</span><br><span class="line">            &#125;).<span class="keyword">catch</span>(error =&gt; &#123;</span><br><span class="line">                callback(error, error.response.data);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    export <span class="keyword">default</span> &#123;</span><br><span class="line">        data() &#123;</span><br><span class="line">            <span class="keyword">return</span> &#123;</span><br><span class="line">                <span class="comment">//loading: false,</span></span><br><span class="line">                users: <span class="keyword">null</span>,</span><br><span class="line">            <span class="comment">//     "meta": &#123;</span></span><br><span class="line">            <span class="comment">//     "current_page": 1,</span></span><br><span class="line">            <span class="comment">//     "from": 1,</span></span><br><span class="line">            <span class="comment">//     "last_page": 5,</span></span><br><span class="line">            <span class="comment">//     "path":</span></span><br><span class="line">            <span class="comment">//     "per_page": 10,</span></span><br><span class="line">            <span class="comment">//     "to": 10,</span></span><br><span class="line">            <span class="comment">//     "total": 50</span></span><br><span class="line">            <span class="comment">// &#125;</span></span><br><span class="line">                meta: <span class="keyword">null</span>,</span><br><span class="line">                links: &#123;</span><br><span class="line">                    first: <span class="keyword">null</span>,</span><br><span class="line">                    last: <span class="keyword">null</span>,</span><br><span class="line">                    next: <span class="keyword">null</span>,</span><br><span class="line">                    prev: <span class="keyword">null</span>,</span><br><span class="line">                &#125;,</span><br><span class="line">                error: <span class="keyword">null</span>,</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;,</span><br><span class="line">        computed: &#123;</span><br><span class="line">            nextPage() &#123;</span><br><span class="line">                <span class="keyword">if</span> (!this.meta || this.meta.current_page ==</span><br><span class="line">                this.meta.last_page) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> this.meta.current_page + <span class="number">1</span>;</span><br><span class="line">            &#125;,</span><br><span class="line">            prevPage() &#123;</span><br><span class="line">                <span class="keyword">if</span> (!this.meta || this.meta.current_page ==</span><br><span class="line">                    <span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> this.meta.current_page - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">            &#125;,</span><br><span class="line">            paginatonCount() &#123;</span><br><span class="line">                <span class="keyword">if</span> (!this.meta) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">const</span> &#123;current_page,last_page&#125; = this.meta;</span><br><span class="line">                <span class="keyword">return</span> `$&#123;current_page&#125; of $&#123;last_page&#125;`;</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">        beforeRouteEnter (to, from, next) &#123;</span><br><span class="line">            getUsers(to.query.page, (err, data) =&gt; &#123;</span><br><span class="line">                next(vm =&gt; vm.setData(err, data));</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;,</span><br><span class="line">        beforeRouteUpdate (to, from, next) &#123;</span><br><span class="line">            this.users = this.links = this.meta = <span class="keyword">null</span></span><br><span class="line">            getUsers(to.query.page, (err, data) =&gt; &#123;</span><br><span class="line">                this.setData(err, data);</span><br><span class="line">                next();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;,</span><br><span class="line">        created() &#123;</span><br><span class="line"></span><br><span class="line">        &#125;,</span><br><span class="line">        methods: &#123;</span><br><span class="line">            goToNext() &#123;</span><br><span class="line">                this.$router.push(&#123;</span><br><span class="line">                    query: &#123;</span><br><span class="line">                        page: this.nextPage,</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;,</span><br><span class="line">            goToPrev() &#123;</span><br><span class="line">                this.$router.push(&#123;</span><br><span class="line">                    name: <span class="string">'users.index'</span>,</span><br><span class="line">                    query: &#123;</span><br><span class="line">                        page: this.prevPage,</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;,</span><br><span class="line">            setData(err, &#123; data: users, links, meta &#125;) &#123;</span><br><span class="line">                <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                    this.error = err.toString();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    this.users = users;</span><br><span class="line">                    this.links = links;</span><br><span class="line">                    this.meta = meta;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">         &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;Laravel-with-Vue-js&quot;&gt;&lt;a href=&quot;#Laravel-with-Vue-js&quot; class=&quot;headerlink&quot; title=&quot;Laravel with Vue.js&quot;&gt;&lt;/a&gt;Laravel with Vue.js&lt;/h1&gt;&lt;p&gt;参考链接：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://learnku.com/laravel/t/34858&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;通过 Laravel 创建一个 Vue 单页面应用&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://router.vuejs.org/zh/guide/essentials/navigation.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Vue-router&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Laravel中使用vue.js实现前后端分离。Laravel 后端只提供 api供 Vue.js 前端调用。&lt;/p&gt;
&lt;h2 id=&quot;Laravel-配置&quot;&gt;&lt;a href=&quot;#Laravel-配置&quot; class=&quot;headerlink&quot; title=&quot;Laravel 配置&quot;&gt;&lt;/a&gt;Laravel 配置&lt;/h2&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ laravel new todo&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;strong&gt;项目的入口 spa 视图&lt;/strong&gt;&lt;br&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ php artisan make:controller SpaController&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
&lt;p&gt;&lt;em&gt;Http/Controllers/SpaController.php&lt;/em&gt;&lt;br&gt;&lt;figure class=&quot;highlight php&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;&amp;lt;?php&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;namespace&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;App&lt;/span&gt;\&lt;span class=&quot;title&quot;&gt;Http&lt;/span&gt;\&lt;span class=&quot;title&quot;&gt;Controllers&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;Illuminate&lt;/span&gt;\&lt;span class=&quot;title&quot;&gt;Http&lt;/span&gt;\&lt;span class=&quot;title&quot;&gt;Request&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;class&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;SpaController&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;extends&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;Controller&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;class&quot;&gt;&lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;function&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;index&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;    &lt;/span&gt;&amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;comment&quot;&gt;// 项目的入口&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;        &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; view(&lt;span class=&quot;string&quot;&gt;&#39;spa&#39;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="Tech" scheme="http://yoursite.com/categories/Tech/"/>
    
    
      <category term="laravel" scheme="http://yoursite.com/tags/laravel/"/>
    
      <category term="vue.js" scheme="http://yoursite.com/tags/vue-js/"/>
    
  </entry>
  
  <entry>
    <title>Laravel with Dingo</title>
    <link href="http://yoursite.com/2019/07/13/Laravel-with-Dingo/"/>
    <id>http://yoursite.com/2019/07/13/Laravel-with-Dingo/</id>
    <published>2019-07-13T09:14:41.000Z</published>
    <updated>2019-07-15T13:15:36.793Z</updated>
    
    <content type="html"><![CDATA[<p> Laravel使用Dingo扩展包<br> 参考：</p><ul><li><a href="https://learnku.com/courses/laravel-advance-training/5.8/install-dingoapi/3990" target="_blank" rel="noopener">安装Dingo</a></li><li><a href="https://learnku.com/courses/laravel-advance-training/5.5/list-of-posts/923#Include-%E6%9C%BA%E5%88%B6" target="_blank" rel="noopener">include机制</a></li><li><a href="https://learnku.com/courses/laravel-advance-training/5.5/reply-list/944" target="_blank" rel="noopener">回复列表</a></li></ul><h2 id="安装-Dingo"><a href="#安装-Dingo" class="headerlink" title="安装 Dingo"></a>安装 Dingo</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ composer require dingo/api</span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ php artisan vendor:publish --provider=<span class="string">"Dingo\Api\Provider\LaravelServiceProvider"</span></span><br></pre></td></tr></table></figure><p><em>.env</em></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">.</span><br><span class="line">.</span><br><span class="line"># prs 未对外发布的，提供给公司 app，单页应用，桌面应用等</span><br><span class="line">API_STANDARDS_TREE=prs</span><br><span class="line"># 项目的简称</span><br><span class="line">API_SUBTYPE=book</span><br><span class="line">API_PREFIX=api</span><br><span class="line">API_VERSION=v1</span><br><span class="line">API_DEBUG=true</span><br></pre></td></tr></table></figure><h2 id="编写调试接口"><a href="#编写调试接口" class="headerlink" title="编写调试接口"></a>编写调试接口</h2><p><em>routes/api.php</em></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">|--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">| API Routes</span></span><br><span class="line"><span class="comment">|--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">|</span></span><br><span class="line"><span class="comment">| Here is where you can register API routes for your application. These</span></span><br><span class="line"><span class="comment">| routes are loaded by the RouteServiceProvider within a group which</span></span><br><span class="line"><span class="comment">| is assigned the "api" middleware group. Enjoy building your API!</span></span><br><span class="line"><span class="comment">|</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">$api = app(<span class="string">'Dingo\Api\Routing\Router'</span>);</span><br><span class="line"></span><br><span class="line">$api-&gt;version(<span class="string">'v1'</span>, <span class="function"><span class="keyword">function</span><span class="params">($api)</span> </span>&#123;</span><br><span class="line">    $api-&gt;get(<span class="string">'version1'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> response(<span class="string">'this is version v1'</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">$api-&gt;version(<span class="string">'v2'</span>, <span class="function"><span class="keyword">function</span><span class="params">($api)</span> </span>&#123;</span><br><span class="line">    $api-&gt;get(<span class="string">'version2'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> response(<span class="string">'this is version v2'</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>v1: GET <a href="http://book.test/api/version1" target="_blank" rel="noopener">http://book.test/api/version1</a><br>v2: GET Headers 中<code>Accept:application/prs.book.v2+json,</code>,<code>Accept: application/&lt;API_STANDARDS_TREE&gt;.&lt;API_SUBTYPE&gt;.v2+json</code><br><a href="http://book.test/api/version2" target="_blank" rel="noopener">http://book.test/api/version2</a></p><h2 id="Transformers"><a href="#Transformers" class="headerlink" title="Transformers"></a>Transformers</h2><p><em>app/Transformers/BookTransformer.php</em> </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Transformers</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">League</span>\<span class="title">Fractal</span>\<span class="title">TransformerAbstract</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">History</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HistoryTransformer</span> <span class="keyword">extends</span>  <span class="title">TransformerAbstract</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $availableIncludes = [<span class="string">'book'</span>];</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">transform</span><span class="params">(History $history)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            <span class="string">'id'</span> =&gt; $history-&gt;id,</span><br><span class="line">            <span class="string">'user_id'</span> =&gt; $history-&gt;user_id,</span><br><span class="line">            <span class="string">'book_id'</span> =&gt; $history-&gt;book_id,</span><br><span class="line">            <span class="string">'borrow_state'</span> =&gt; $history-&gt;borrow_state,</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// $history 依赖注入,$history-&gt;book，history与book的关联，</span></span><br><span class="line">    <span class="comment">// 关联定义在model中</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">includeBook</span><span class="params">(History $history)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;item($history-&gt;book,<span class="keyword">new</span> BookTransformer());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>继承<code>League\Fractal\TransformerAbstract</code>类，实现transform方法。<br>include机制，返回history信息时，返回额外的book信息</p><h3 id="include机制的调试"><a href="#include机制的调试" class="headerlink" title="include机制的调试"></a>include机制的调试</h3><p>某个用户借阅的所有图书<br><code>/users/:id/borrowed/histories?include=book</code><br>响应：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"data"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">"id"</span>: <span class="number">16</span>,</span><br><span class="line">            <span class="attr">"user_id"</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="attr">"book_id"</span>: <span class="number">11</span>,</span><br><span class="line">            <span class="attr">"borrow_state"</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="attr">"book"</span>: &#123;</span><br><span class="line">                <span class="attr">"id"</span>: <span class="number">11</span>,</span><br><span class="line">                <span class="attr">"isbn"</span>: <span class="string">"98788199293"</span>,</span><br><span class="line">                <span class="attr">"title"</span>: <span class="string">"testtitle"</span>,</span><br><span class="line">                <span class="attr">"author"</span>: <span class="string">"testauthor"</span>,</span><br><span class="line">                <span class="attr">"owner"</span>: <span class="string">"testowner"</span>,</span><br><span class="line">                <span class="attr">"total_borrow"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"missing_num"</span>: <span class="number">0</span>,</span><br><span class="line">                <span class="attr">"total_num"</span>: <span class="number">1</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Dingo路由隐式绑定"><a href="#Dingo路由隐式绑定" class="headerlink" title="Dingo路由隐式绑定"></a>Dingo路由隐式绑定</h2><p><em>routes/api.php</em><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$api-&gt;version(‘v1’,[</span><br><span class="line">    ‘<span class="keyword">namespace</span>’ =&gt; ‘<span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Api</span>’,</span><br><span class="line">    ‘<span class="title">middleware</span>’ =&gt; [‘<span class="title">serializer</span>:<span class="title">array</span>’, ‘<span class="title">bindings</span>’]</span><br><span class="line">],/<span class="title">function</span>/($<span class="title">api</span>)&#123;</span><br><span class="line">   $<span class="title">api</span>-&gt;<span class="title">get</span>(‘/<span class="title">books</span>/&#123;<span class="title">book</span>&#125;’,’<span class="title">BooksController</span>@<span class="title">show</span>’)</span><br><span class="line">    -&gt;name(‘api.books.show’); </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p><p>增加bindings中间件。</p><p><em>app/Http/Controllers/Api/BooksController.php</em></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Api</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Requests</span>\<span class="title">Api</span>\<span class="title">BookRequest</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Book</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Transformers</span>\<span class="title">BookTransformer</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BooksController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    .</span><br><span class="line">    .</span><br><span class="line">    .</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">show</span><span class="params">(Book $book)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;response-&gt;item($book,<span class="keyword">new</span> BookTransformer());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>postman中<br><a href="http://book.test/api/book/:id" target="_blank" rel="noopener">http://book.test/api/book/:id</a></p><p><img src="http://ww2.sinaimg.cn/large/006tNc79gy1g50rxhedslj31kk0suaaz.jpg" alt></p><h2 id="分页"><a href="#分页" class="headerlink" title="分页"></a>分页</h2><p><em>app/Http/Controllers/Api/BooksController.php</em></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Api</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Requests</span>\<span class="title">Api</span>\<span class="title">BookRequest</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Book</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Transformers</span>\<span class="title">BookTransformer</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BooksController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $books =Book::paginate(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;response-&gt;paginator($books,<span class="keyword">new</span> BookTransformer());</span><br><span class="line">    &#125;</span><br><span class="line">        .</span><br><span class="line">        .</span><br><span class="line">        .</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt; Laravel使用Dingo扩展包&lt;br&gt; 参考：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://learnku.com/courses/laravel-advance-training/5.8/install-dingoapi/3990&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;安装Dingo&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://learnku.com/courses/laravel-advance-training/5.5/list-of-posts/923#Include-%E6%9C%BA%E5%88%B6&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;include机制&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://learnku.com/courses/laravel-advance-training/5.5/reply-list/944&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;回复列表&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;安装-Dingo&quot;&gt;&lt;a href=&quot;#安装-Dingo&quot; class=&quot;headerlink&quot; title=&quot;安装 Dingo&quot;&gt;&lt;/a&gt;安装 Dingo&lt;/h2&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ composer require dingo/api&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="Tech" scheme="http://yoursite.com/categories/Tech/"/>
    
    
      <category term="laravel" scheme="http://yoursite.com/tags/laravel/"/>
    
      <category term="dingo" scheme="http://yoursite.com/tags/dingo/"/>
    
  </entry>
  
  <entry>
    <title>微信小程序微信登录</title>
    <link href="http://yoursite.com/2019/06/22/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95/"/>
    <id>http://yoursite.com/2019/06/22/微信小程序微信登录/</id>
    <published>2019-06-22T03:09:27.000Z</published>
    <updated>2019-06-23T00:13:25.908Z</updated>
    
    <content type="html"><![CDATA[<p>微信小程序 微信登录<br>参考：</p><ul><li><a href="https://learnku.com/courses/laravel-advance-training/5.8/mobile-login-api/4004" target="_blank" rel="noopener">jwt-auth</a></li><li><a href="https://learnku.com/courses/laravel-weapp/5.5/small-program-login-interface/1483" target="_blank" rel="noopener">小程序登录</a></li></ul><h2 id="使用微信登录"><a href="#使用微信登录" class="headerlink" title="使用微信登录"></a>使用微信登录</h2><h3 id="jwt"><a href="#jwt" class="headerlink" title="jwt"></a>jwt</h3><blockquote><p>JWT 由头部（header）、载荷（payload）与签名（signature）组成.客户端请求的时候在 Header 中携带 Token，服务器获取 Token 后，进行 base64_decode 即可获取数据进行校验<br><a id="more"></a></p></blockquote><h4 id="token验证过程"><a href="#token验证过程" class="headerlink" title="token验证过程"></a>token验证过程</h4><blockquote><p>DingoApi api.auth 中间件完成了token 验证。</p><ul><li>获取客户端提交的 token</li><li>检测 token 中的签名 signature 是否正确</li><li>判断 payload 数据中的 exp，是否已经过期</li><li>根据 payload 数据中的 sub，取数据库中验证用户是否存在<br>上述检测不正确，则抛出相应异常</li></ul></blockquote><h3 id="安装jwt-auth"><a href="#安装jwt-auth" class="headerlink" title="安装jwt-auth"></a>安装jwt-auth</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ composer require tymon/jwt-auth:1.0.0-rc.4.1</span><br><span class="line"></span><br><span class="line">//设置jwt的secret,用于最后的签名</span><br><span class="line">$ php artisan jwt:secret</span><br></pre></td></tr></table></figure><p><em>config/auth.php</em></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="string">'guards'</span> =&gt; [</span><br><span class="line">    <span class="string">'web'</span> =&gt; [</span><br><span class="line">        <span class="string">'driver'</span> =&gt; <span class="string">'session'</span>,</span><br><span class="line">        <span class="string">'provider'</span> =&gt; <span class="string">'users'</span>,</span><br><span class="line">    ],</span><br><span class="line"></span><br><span class="line">    <span class="string">'api'</span> =&gt; [</span><br><span class="line">        <span class="string">'driver'</span> =&gt; <span class="string">'jwt'</span>,</span><br><span class="line">        <span class="string">'provider'</span> =&gt; <span class="string">'users'</span>,</span><br><span class="line">    ],</span><br><span class="line">],</span><br></pre></td></tr></table></figure><p><em>config/api.php</em></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="string">'auth'</span> =&gt; [</span><br><span class="line">    <span class="string">'jwt'</span> =&gt; <span class="string">'Dingo\Api\Auth\Provider\JWT'</span>,</span><br><span class="line">],</span><br></pre></td></tr></table></figure><p><em>app/User.php</em></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">use</span> <span class="title">Tymon</span>\<span class="title">JWTAuth</span>\<span class="title">Contracts</span>\<span class="title">JWTSubject</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Authenticatable</span> <span class="keyword">implements</span> <span class="title">JWTSubject</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//返回user的id</span></span><br><span class="line">     <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getJWTIdentifier</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getKey();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//jwt payload 增加的自定义内容</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getJWTCustomClaims</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> [];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>进入 tinker<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$user</span>= App\User::first();</span><br><span class="line">//生成access_token</span><br><span class="line">Auth::guard(<span class="string">'api'</span>)-&gt;fromUser(<span class="variable">$user</span>);</span><br></pre></td></tr></table></figure></p><h3 id="修改数据表"><a href="#修改数据表" class="headerlink" title="修改数据表"></a>修改数据表</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ php artisan make:migration add_weixin_session_key_to_users_table --table=users</span><br></pre></td></tr></table></figure><p><em>database/migrations/&lt;your_date&gt;add_weixin_session_key_to_users_table.php</em></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Facades</span>\<span class="title">Schema</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Schema</span>\<span class="title">Blueprint</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Migrations</span>\<span class="title">Migration</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AddWeixinSessionKeyToUsersTable</span> <span class="keyword">extends</span> <span class="title">Migration</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Run the migrations.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">up</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Schema::table(<span class="string">'users'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(Blueprint $table)</span> </span>&#123;</span><br><span class="line">            $table-&gt;string(<span class="string">'weapp_openid'</span>)-&gt;nullable()-&gt;unique();</span><br><span class="line">            $table-&gt;string(<span class="string">'weapp_session_key'</span>)-&gt;nullable()-&gt;after(<span class="string">'weapp_openid'</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Reverse the migrations.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">down</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Schema::table(<span class="string">'users'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(Blueprint $table)</span> </span>&#123;</span><br><span class="line">            $table-&gt;dropColumn(<span class="string">'weapp_openid'</span>);</span><br><span class="line">            $table-&gt;dropColumn(<span class="string">'weapp_session_key'</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ php artisan migrate</span><br></pre></td></tr></table></figure><h3 id="增加路由"><a href="#增加路由" class="headerlink" title="增加路由"></a>增加路由</h3><p><em>routes/api.php</em><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">//微信登录</span></span><br><span class="line">        $api-&gt;post(<span class="string">'weapp/authorizations'</span>,<span class="string">'AuthorizationsController@weappStore'</span>)</span><br><span class="line">            -&gt;name(<span class="string">'api.weapp.authorizations.store'</span>);</span><br></pre></td></tr></table></figure></p><h3 id="增加Request"><a href="#增加Request" class="headerlink" title="增加Request"></a>增加Request</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ php artisan make:request Api/WeappAuthorizationRequest</span><br></pre></td></tr></table></figure><p><em>app/Http/Requests/Api/WeappAuthorizationRequest.php</em></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Requests</span>\<span class="title">Api</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WeappAuthorizationRequest</span> <span class="keyword">extends</span> <span class="title">FormRequest</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the validation rules that apply to the request.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">rules</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            <span class="string">'code'</span> =&gt; <span class="string">'required|string'</span>,</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="修改Controller"><a href="#修改Controller" class="headerlink" title="修改Controller"></a>修改Controller</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Api</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Requests</span>\<span class="title">Api</span>\<span class="title">WeappAuthorizationRequest</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">User</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Auth</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AuthorizationsController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">weappStore</span><span class="params">(WeappAuthorizationRequest $request)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $code = $request-&gt;code;</span><br><span class="line"></span><br><span class="line">        $miniProgram = \EasyWeChat::miniProgram();</span><br><span class="line">        $data = $miniProgram-&gt;auth-&gt;session($code);</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($data[<span class="string">'errcode'</span>])) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;response-&gt;errorUnauthorized(<span class="string">'code不正确'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//根据weapp_openid查找用户</span></span><br><span class="line">        $user = User::where(<span class="string">'weapp_openid'</span>,$data[<span class="string">'openid'</span>])-&gt;first();</span><br><span class="line"></span><br><span class="line">        $attributes[<span class="string">'weapp_session_key'</span>] = $data[<span class="string">'session_key'</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!$user) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!$request-&gt;username) &#123;</span><br><span class="line">                <span class="comment">//403 status code</span></span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;response-&gt;errorForbidden(<span class="string">'用户不存在'</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            $username = $request-&gt;username;</span><br><span class="line"></span><br><span class="line">            filter_var($username,FILTER_VALIDATE_EMAIL) ?</span><br><span class="line">                $credentials[<span class="string">'email'</span>] = $username :</span><br><span class="line">                $credentials[<span class="string">'phone'</span>] = $username;</span><br><span class="line"></span><br><span class="line">            $credentials[<span class="string">'password'</span>] = $request-&gt;password;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//验证登录的用户是否存在</span></span><br><span class="line">            <span class="keyword">if</span> (!Auth::guard(<span class="string">'api'</span>)-&gt;attempt($credentials)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;response-&gt;errorUnauthorized(<span class="string">'用户名和密码不正确'</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            $user = Auth::guard(<span class="string">'api'</span>)-&gt;getUser();</span><br><span class="line">            $attributes[<span class="string">'weapp_openid'</span>] = $data[<span class="string">'openid'</span>];</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//更新用户的weapp_openid,weapp_session_key</span></span><br><span class="line">        $user-&gt;update($attributes);</span><br><span class="line"></span><br><span class="line">        $token = Auth::guard(<span class="string">'api'</span>)-&gt;fromUser($user);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;respondWithToken($token);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">respondWithToken</span><span class="params">($token)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;response-&gt;array([</span><br><span class="line">            <span class="string">'access_token'</span> =&gt; $token,</span><br><span class="line">            <span class="string">'token_type'</span> =&gt; <span class="string">'Bearer'</span>,</span><br><span class="line">            <span class="string">'expires_in'</span> =&gt; \Auth::guard(<span class="string">'api'</span>)-&gt;factory()-&gt;getTTL() * <span class="number">60</span></span><br><span class="line">        ]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>提交 code,验证 code 的正确性</li><li>通过 openid 查找用户，用户不存在，且用户未提交用户名，返回403</li><li>用户不存在 ，用户名提交用户名和密码，验证用户和密码是否正确，错误返回401</li><li>未绑定微信的用户更新 openid,session_key;绑定的用户只更新 session_key.</li><li>最后返回 access_token</li></ul><p><em>app/User.php</em></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">protected</span> $fillable = [</span><br><span class="line">        <span class="string">'name'</span>, <span class="string">'email'</span>, <span class="string">'password'</span>,<span class="string">'phone'</span>,<span class="string">'weapp_openid'</span>,<span class="string">'weapp_session_key'</span>,</span><br><span class="line">    ];</span><br></pre></td></tr></table></figure><h3 id="Postman测试"><a href="#Postman测试" class="headerlink" title="Postman测试"></a>Postman测试</h3><p><strong>code只能使用一次，每次测试要刷新微信小程序端的code</strong><br><img src="http://ww4.sinaimg.cn/large/006tNc79gy1g4arsp0we8j30pn0aldg0.jpg" alt><br>code验证通过，没有提交用户名</p><p><img src="http://ww2.sinaimg.cn/large/006tNc79gy1g4a9bf4e8ij31jm0rcdhf.jpg" alt><br>用户名和密码验证用过，没有和微信绑定的情况</p><p><img src="http://ww4.sinaimg.cn/large/006tNc79gy1g4a9h0wwuqj31k00qqjsz.jpg" alt><br>用户和微信绑定的情况</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;微信小程序 微信登录&lt;br&gt;参考：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://learnku.com/courses/laravel-advance-training/5.8/mobile-login-api/4004&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;jwt-auth&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://learnku.com/courses/laravel-weapp/5.5/small-program-login-interface/1483&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;小程序登录&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;使用微信登录&quot;&gt;&lt;a href=&quot;#使用微信登录&quot; class=&quot;headerlink&quot; title=&quot;使用微信登录&quot;&gt;&lt;/a&gt;使用微信登录&lt;/h2&gt;&lt;h3 id=&quot;jwt&quot;&gt;&lt;a href=&quot;#jwt&quot; class=&quot;headerlink&quot; title=&quot;jwt&quot;&gt;&lt;/a&gt;jwt&lt;/h3&gt;&lt;blockquote&gt;
&lt;p&gt;JWT 由头部（header）、载荷（payload）与签名（signature）组成.客户端请求的时候在 Header 中携带 Token，服务器获取 Token 后，进行 base64_decode 即可获取数据进行校验&lt;br&gt;
    
    </summary>
    
      <category term="Tech" scheme="http://yoursite.com/categories/Tech/"/>
    
    
      <category term="laravel" scheme="http://yoursite.com/tags/laravel/"/>
    
      <category term="api" scheme="http://yoursite.com/tags/api/"/>
    
      <category term="微信小程序" scheme="http://yoursite.com/tags/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F/"/>
    
  </entry>
  
  <entry>
    <title>微信小程序手机登录</title>
    <link href="http://yoursite.com/2019/06/15/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F%E7%99%BB%E5%BD%95/"/>
    <id>http://yoursite.com/2019/06/15/微信小程序登录/</id>
    <published>2019-06-15T13:38:11.000Z</published>
    <updated>2019-07-15T13:15:23.836Z</updated>
    
    <content type="html"><![CDATA[<p>微信小程序分别使用<strong>手机号</strong>和<strong>微信</strong>登录<br>参考：</p><ul><li><a href="https://github.com/overtrue/easy-sms" target="_blank" rel="noopener">easy-sms</a></li><li><a href="https://learnku.com/courses/laravel-advance-training/5.5/sms-provider/791" target="_blank" rel="noopener">短信提供商</a></li><li><a href="https://learnku.com/courses/laravel-advance-training/5.8/development-of-mobile-phone-registration-function/3995" target="_blank" rel="noopener">手机注册验证码</a></li><li><a href="https://learnku.com/courses/laravel-advance-training/5.8/picture-verification-code/3998" target="_blank" rel="noopener">图片验证码</a></li></ul><h2 id="使用手机登录"><a href="#使用手机登录" class="headerlink" title="使用手机登录"></a>使用手机登录</h2><h3 id="发送手机短信"><a href="#发送手机短信" class="headerlink" title="发送手机短信"></a>发送手机短信</h3><h4 id="安装easy-sms"><a href="#安装easy-sms" class="headerlink" title="安装easy-sms"></a>安装easy-sms</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ composer require <span class="string">"overtrue/easy-sms"</span></span><br><span class="line"><span class="comment"># config中添加easysms.php 配置文件</span></span><br><span class="line">$ touch config/easysms.php</span><br></pre></td></tr></table></figure><a id="more"></a><p><em>config.easysms.php</em><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">return</span> [</span><br><span class="line">    <span class="comment">// HTTP 请求的超时时间（秒）</span></span><br><span class="line">    <span class="string">'timeout'</span> =&gt; <span class="number">5.0</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 默认发送配置</span></span><br><span class="line">    <span class="string">'default'</span> =&gt; [</span><br><span class="line">        <span class="comment">// 网关调用策略，默认：顺序调用</span></span><br><span class="line">        <span class="string">'strategy'</span> =&gt; \Overtrue\EasySms\Strategies\OrderStrategy::class,</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 默认可用的发送网关</span></span><br><span class="line">        <span class="string">'gateways'</span> =&gt; [</span><br><span class="line">            <span class="string">'qcloud'</span>,</span><br><span class="line">        ],</span><br><span class="line">    ],</span><br><span class="line">    <span class="comment">// 可用的网关配置</span></span><br><span class="line">    <span class="string">'gateways'</span> =&gt; [</span><br><span class="line">        <span class="string">'errorlog'</span> =&gt; [</span><br><span class="line">            <span class="string">'file'</span> =&gt; <span class="string">'/tmp/easy-sms.log'</span>,</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">'qcloud'</span> =&gt; [</span><br><span class="line">            <span class="string">'sdk_app_id'</span> =&gt; env(<span class="string">'QCLOUD_APP_ID'</span>), <span class="comment">// SDK APP ID</span></span><br><span class="line">            <span class="string">'app_key'</span> =&gt; env(<span class="string">'QCLOUD_APP_KEY'</span>), <span class="comment">// APP KEY</span></span><br><span class="line">            <span class="string">'sign_name'</span> =&gt; env(<span class="string">'QCLOUD_APP_SIGN_NAME'</span>), <span class="comment">// 短信签名，如果使用默认签名，该字段可缺省（对应官方文档中的sign）</span></span><br><span class="line">        ],</span><br><span class="line">    ],</span><br><span class="line">];</span><br></pre></td></tr></table></figure></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ php artisan make:provider EasySmsServiceProvider</span><br></pre></td></tr></table></figure><h4 id="创建一个-ServiceProvider"><a href="#创建一个-ServiceProvider" class="headerlink" title="创建一个 ServiceProvider"></a>创建一个 ServiceProvider</h4><p><em>app/providers/EasySmsServiceProvider.php</em><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Providers</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">ServiceProvider</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Overtrue</span>\<span class="title">EasySms</span>\<span class="title">EasySms</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EasySmsServiceProvider</span> <span class="keyword">extends</span> <span class="title">ServiceProvider</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Register services.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;app-&gt;singleton(EasySms::class, <span class="function"><span class="keyword">function</span> <span class="params">($app)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> EasySms(config(<span class="string">'easysms'</span>));</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;app-&gt;alias(EasySms::class, <span class="string">'easysms'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Bootstrap services.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>修改EasySmsServiceProvider.php</p><h4 id="获取SDK-AppID，App-Key"><a href="#获取SDK-AppID，App-Key" class="headerlink" title="获取SDK AppID，App Key"></a>获取SDK AppID，App Key</h4><p><a href="https://console.cloud.tencent.com/sms/smslist" target="_blank" rel="noopener">腾讯云短信</a>获取SDK AppID，App Key<br><strong>注意：</strong>不同的应用有不同的AppID，App Key,要对应。调试时没有对应，导致发送失败。</p><p><em>.env</em><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">QCLOUD_APP_ID=</span><br><span class="line">QCLOUD_APP_KEY=</span><br><span class="line">QCLOUD_APP_SIGN_NAME=scottyun</span><br></pre></td></tr></table></figure></p><h4 id="发送短信"><a href="#发送短信" class="headerlink" title="发送短信"></a>发送短信</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php artisan tinker</span><br></pre></td></tr></table></figure><p>进入tinker<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt; $sms = app(&apos;easysms&apos;);</span><br><span class="line">&gt;&gt; $sms-&gt;send(13212345678, [</span><br><span class="line">        &apos;content&apos;  =&gt; &apos;【Lbbs社区】您的验证码是1234。如非本人操作，请忽略本短信&apos;,</span><br><span class="line">    ]);</span><br></pre></td></tr></table></figure></p><p>国内短信由签名+正文组成，【Lbbs社区】是短信签名;”您的验证码是{1}。如非本人操作，请忽略本短信”短信正文</p><h3 id="修改数据结构"><a href="#修改数据结构" class="headerlink" title="修改数据结构"></a>修改数据结构</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php artisan make:migration add_phone_to_users_table --table=users</span><br></pre></td></tr></table></figure><p><em>database/migrations/{your_date}_add_phone_to_users_table.php</em></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Facades</span>\<span class="title">Schema</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Schema</span>\<span class="title">Blueprint</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Migrations</span>\<span class="title">Migration</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AddPhoneToUsersTable</span> <span class="keyword">extends</span> <span class="title">Migration</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Run the migrations.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">up</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Schema::table(<span class="string">'users'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(Blueprint $table)</span> </span>&#123;</span><br><span class="line">            $table-&gt;string(<span class="string">'phone'</span>)-&gt;nullable()-&gt;unique()-&gt;after(<span class="string">'name'</span>);</span><br><span class="line">            $table-&gt;string(<span class="string">'email'</span>)-&gt;nullable()-&gt;change();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Reverse the migrations.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">down</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        Schema::table(<span class="string">'users'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(Blueprint $table)</span> </span>&#123;</span><br><span class="line">            $table-&gt;dropColumn(<span class="string">'phone'</span>);</span><br><span class="line">            $table-&gt;string(<span class="string">'email'</span>)-&gt;nullable(<span class="keyword">false</span>)-&gt;change();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改数据表的字段属性</span></span><br><span class="line">$ composer require doctrine/dbal</span><br><span class="line">$ php artisan migrate</span><br></pre></td></tr></table></figure><h3 id="短信验证码接口"><a href="#短信验证码接口" class="headerlink" title="短信验证码接口"></a>短信验证码接口</h3><p>1.输入手机号，手机短信验证码发送<br>2.填入短信验证码，验证是否成功<br>3.成功完成注册，创建用户</p><h4 id="新建基类"><a href="#新建基类" class="headerlink" title="新建基类"></a>新建基类</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ php artisan make:controller Api/Controller</span><br></pre></td></tr></table></figure><p><em>app/Http/Controllers/Api/Controller.php</em></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Api</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Controller</span> <span class="title">as</span> <span class="title">BaseController</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Dingo</span>\<span class="title">Api</span>\<span class="title">Routing</span>\<span class="title">Helpers</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Controller</span> <span class="keyword">extends</span> <span class="title">BaseController</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">Helpers</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><em>routes/api.php</em></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span>;</span><br><span class="line">$api = app(<span class="string">'Dingo\Api\Routing\Router'</span>);</span><br><span class="line"></span><br><span class="line">$api-&gt;version(<span class="string">'v1'</span>, [</span><br><span class="line">    <span class="string">'namespace'</span> =&gt; <span class="string">'App\Http\Controllers\Api'</span></span><br><span class="line">], <span class="function"><span class="keyword">function</span><span class="params">($api)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 短信验证码</span></span><br><span class="line">    $api-&gt;post(<span class="string">'verificationCodes'</span>, <span class="string">'VerificationCodesController@store'</span>)</span><br><span class="line">        -&gt;name(<span class="string">'api.verificationCodes.store'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h4 id="创建验证类"><a href="#创建验证类" class="headerlink" title="创建验证类"></a>创建验证类</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ php artisan make:request Api/VerificationCodeRequest</span><br><span class="line"><span class="comment"># 使用Dingo 的 FormRequest</span></span><br><span class="line">$ php artisan make:request Api/FormRequest</span><br></pre></td></tr></table></figure><p><em>app/Http/Requests/Api/FormRequest.php</em></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Requests</span>\<span class="title">Api</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Dingo</span>\<span class="title">Api</span>\<span class="title">Http</span>\<span class="title">FormRequest</span> <span class="title">as</span> <span class="title">BaseFormRequest</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FormRequest</span> <span class="keyword">extends</span> <span class="title">BaseFormRequest</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Determine if the user is authorized to make this request.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> bool</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">authorize</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><em>app/Http/Requests/Api/VerificationCodeRequest.php</em></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//移除自带的 FormRequest</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Requests</span>\<span class="title">Api</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VerificationCodeRequest</span> <span class="keyword">extends</span> <span class="title">FormRequest</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">rules</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            <span class="string">'phone'</span> =&gt; [</span><br><span class="line">                <span class="string">'required'</span>,</span><br><span class="line">                <span class="string">'regex:/^((13[0-9])|(14[5,7])|(15[0-3,5-9])|(17[0,3,5-8])|(18[0-9])|166|198|199)\d&#123;8&#125;$/'</span>,</span><br><span class="line">                <span class="string">'unique:users'</span></span><br><span class="line">            ]</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="创建控制器"><a href="#创建控制器" class="headerlink" title="创建控制器"></a>创建控制器</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ php artisan make:controller Api/VerificationCodesController</span><br></pre></td></tr></table></figure><p><em>app/Http/Controllers/Api/VerificationCodesController.php</em></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Api</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Requests</span>\<span class="title">Api</span>\<span class="title">VerificationCodeRequest</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Overtrue</span>\<span class="title">EasySms</span>\<span class="title">EasySms</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VerificationCodesController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">store</span><span class="params">(VerificationCodeRequest $request,EasySms $easySms)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $phone = $request-&gt;phone;</span><br><span class="line">        <span class="comment"># 开发环境验证码1234</span></span><br><span class="line">        <span class="keyword">if</span> (!app()-&gt;environment(<span class="string">'production'</span>)) &#123;</span><br><span class="line">            $code = <span class="string">'1234'</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $code = str_pad(random_int(<span class="number">1</span>, <span class="number">9999</span>), <span class="number">4</span>, <span class="number">0</span>, STR_PAD_LEFT);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                 $easySms-&gt;send($phone, [</span><br><span class="line">                    <span class="string">'content'</span> =&gt; <span class="string">"【scottyun】larabbs短信验证码 &#123;$code&#125;，不是本人请忽略"</span></span><br><span class="line">                ]);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (\Overtrue\EasySms\Exceptions\NoGatewayAvailableException $exception) &#123;</span><br><span class="line">                $message = $exception-&gt;getException(<span class="string">'qcloud'</span>)-&gt;getMessage();</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;response-&gt;errorInternal($message ?: <span class="string">'短信发送异常'</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $key = <span class="string">'verificationCode_'</span> . \EasyWeChat\Kernel\Support\str_random(<span class="number">15</span>);</span><br><span class="line">        $expiredAt = now()-&gt;addMinutes(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 验证码10mins过期</span></span><br><span class="line">        \Cache::put($key, [<span class="string">'phone'</span> =&gt; $phone, <span class="string">'code'</span> =&gt; $code], $expiredAt);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;response-&gt;array([</span><br><span class="line">            <span class="string">'key'</span> =&gt; $key,</span><br><span class="line">            <span class="string">'expired'</span> =&gt; $expiredAt,</span><br><span class="line">        ])-&gt;setStatusCode(<span class="number">201</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>生成四位随机码，用easysms发送</li><li>验证码放入缓存有效期10 mins</li><li>返回 key和过期时间，缓存中存储了phone ,code;和用户输入的验证码比对</li></ul><h3 id="用户注册接口"><a href="#用户注册接口" class="headerlink" title="用户注册接口"></a>用户注册接口</h3><p><em>routes/api.php</em></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">...</span><br><span class="line">$api-&gt;version(<span class="string">'v1'</span>, [</span><br><span class="line">    <span class="string">'namespace'</span> =&gt; <span class="string">'App\Http\Controllers\Api'</span></span><br><span class="line">], <span class="function"><span class="keyword">function</span><span class="params">($api)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 短信验证码</span></span><br><span class="line">    $api-&gt;post(<span class="string">'verificationCodes'</span>, <span class="string">'VerificationCodesController@store'</span>)</span><br><span class="line">        -&gt;name(<span class="string">'api.verificationCodes.store'</span>);</span><br><span class="line">    <span class="comment">// 用户注册</span></span><br><span class="line">    $api-&gt;post(<span class="string">'users'</span>, <span class="string">'UsersController@store'</span>)</span><br><span class="line">        -&gt;name(<span class="string">'api.users.store'</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h4 id="创建控制器和验证类"><a href="#创建控制器和验证类" class="headerlink" title="创建控制器和验证类"></a>创建控制器和验证类</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ php artisan make:controller Api/UsersController</span><br><span class="line">$ php artisan make:request Api/UserRequest</span><br></pre></td></tr></table></figure><p><em>app/Http/Requests/Api/UserRequest.php</em></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Requests</span>\<span class="title">Api</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserRequest</span> <span class="keyword">extends</span> <span class="title">FormRequest</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the validation rules that apply to the request.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">rules</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            <span class="string">'name'</span> =&gt; <span class="string">'required|between:3,25|regex:/^[A-Za-z0-9\-\_]+$/|unique:users,name'</span>,</span><br><span class="line">            <span class="string">'password'</span> =&gt; <span class="string">'required|string|min:6'</span>,</span><br><span class="line">            <span class="string">'verification_key'</span> =&gt; <span class="string">'required|string'</span>,</span><br><span class="line">            <span class="string">'verification_code'</span> =&gt; <span class="string">'required|string'</span>,</span><br><span class="line"></span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">attributes</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            <span class="string">'verification_key'</span> =&gt; <span class="string">'短信验证码 key'</span>,</span><br><span class="line">            <span class="string">'verification_code'</span> =&gt; <span class="string">'短信验证码'</span>,</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>用户注册提交的数据，name,password,verification_code。verification_key由$api-&gt;post(‘verificationCodes’, ‘VerificationCodesController@store’)产生。</p><p><em>app/Http/Controllers/Api/UsersController.php</em></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Api</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Requests</span>\<span class="title">Api</span>\<span class="title">UserRequest</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">User</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UsersController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">store</span><span class="params">(UserRequest $request)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $verifyData = \Cache::get($request-&gt;verification_key);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!$verifyData) &#123;</span><br><span class="line">        <span class="comment">//422 表示提交的参数错误</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;response-&gt;error(<span class="string">'验证码已失效'</span>, <span class="number">422</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!hash_equals($verifyData[<span class="string">'code'</span>], $request-&gt;verification_code)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;response-&gt;errorUnauthorized(<span class="string">'验证码错误'</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $user = User::create([</span><br><span class="line">            <span class="string">'name'</span> =&gt; $request-&gt;name,</span><br><span class="line">            <span class="string">'phone'</span> =&gt; $request-&gt;phone,</span><br><span class="line">            <span class="string">'password'</span> =&gt; bcrypt($request-&gt;password),</span><br><span class="line">        ]);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//清空缓存</span></span><br><span class="line">        \Cache::forget($request-&gt;verification_key);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;response-&gt;created();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>判断验证码是否失效，再判断验证码是否正确。最后完成用户注册，清空缓存。</p><p><img src="http://ww3.sinaimg.cn/large/006tNc79gy1g492aeyltbj31ka0tit9m.jpg" alt="用户注册"></p><h3 id="图片验证码"><a href="#图片验证码" class="headerlink" title="图片验证码"></a>图片验证码</h3><p>短信验证码发送之前要输入验证码。</p><h4 id="安装gregwar-captcha"><a href="#安装gregwar-captcha" class="headerlink" title="安装gregwar/captcha"></a>安装gregwar/captcha</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ composer require gregwar/captcha</span><br></pre></td></tr></table></figure><p><em>routes/api.php</em></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 图片验证码</span></span><br><span class="line">   $api-&gt;post(<span class="string">'captchas'</span>, <span class="string">'CaptchasController@store'</span>)</span><br><span class="line">       -&gt;name(<span class="string">'api.captchas.store'</span>);</span><br></pre></td></tr></table></figure><h4 id="创建控制器和验证类-1"><a href="#创建控制器和验证类-1" class="headerlink" title="创建控制器和验证类"></a>创建控制器和验证类</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ php artisan make:controller Api/CaptchasController</span><br><span class="line">$ php artisan make:request Api/CaptchaRequest</span><br></pre></td></tr></table></figure><p><em>app/Http/Requests/Api/CaptchaRequest.php</em></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Requests</span>\<span class="title">Api</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CaptchaRequest</span> <span class="keyword">extends</span> <span class="title">FormRequest</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the validation rules that apply to the request.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">rules</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            <span class="string">'phone'</span> =&gt; [</span><br><span class="line">                <span class="string">'required'</span>,</span><br><span class="line">                <span class="string">'regex:/^((13[0-9])|(14[5,7])|(15[0-3,5-9])|(17[0,3,5-8])|(18[0-9])|166|198|199)\d&#123;8&#125;$/'</span>,</span><br><span class="line">                <span class="string">'unique:users'</span></span><br><span class="line">            ]</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><em>app/Http/Controllers/Api/CaptchasController.php</em></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Api</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Requests</span>\<span class="title">Api</span>\<span class="title">CaptchaRequest</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Gregwar</span>\<span class="title">Captcha</span>\<span class="title">CaptchaBuilder</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CaptchasController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">store</span><span class="params">(CaptchaRequest $request,CaptchaBuilder $captchaBuilder)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $key = <span class="string">'captcha-'</span>.\EasyWeChat\Kernel\Support\str_random(<span class="number">15</span>);</span><br><span class="line">        $phone = $request-&gt;phone;</span><br><span class="line"></span><br><span class="line">        $captcha = $captchaBuilder-&gt;build();</span><br><span class="line">        $expiredAt = now()-&gt;addMinutes(<span class="number">2</span>);</span><br><span class="line">        \Cache::put($key,[<span class="string">'phone'</span> =&gt; $phone,<span class="string">'code'</span> =&gt; $captcha-&gt;getPhrase()],$expiredAt);</span><br><span class="line"></span><br><span class="line">        $result = [</span><br><span class="line">            <span class="string">'captcha_key'</span> =&gt; $key,</span><br><span class="line">            <span class="string">'expired_at'</span> =&gt; $expiredAt,</span><br><span class="line">            <span class="string">'captcha_image_content'</span> =&gt; $captcha-&gt;inline(),</span><br><span class="line">        ];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;response-&gt;array($result)-&gt;setStatusCode(<span class="number">201</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>生成验证码，和phone 一起存入缓存中。返回key，过期时间，给用户看到的验证码图片。</p><p><img src="http://ww4.sinaimg.cn/large/006tNc79gy1g4943uopv2j31i70u00xs.jpg" alt><br>注册码生成</p><h4 id="修改短信验证码接口"><a href="#修改短信验证码接口" class="headerlink" title="修改短信验证码接口"></a>修改短信验证码接口</h4><p><em>app/Http/Requests/Api/VerificationCodeRequest.php</em></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Requests</span>\<span class="title">Api</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VerificationCodeRequest</span> <span class="keyword">extends</span> <span class="title">FormRequest</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the validation rules that apply to the request.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">rules</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            <span class="string">'captcha_key'</span> =&gt; <span class="string">'required|string'</span>,</span><br><span class="line">            <span class="string">'captcha_code'</span> =&gt; <span class="string">'required|string'</span>,</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">attributes</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            <span class="string">'captcha_key'</span> =&gt; <span class="string">'图片验证码 key'</span>,</span><br><span class="line">            <span class="string">'captcha_code'</span> =&gt; <span class="string">'图片验证码'</span>,</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过图片验证码验证是否发送短信给用户。</p><p><em>app/Http/Controllers/Api/VerificationCodesController.php</em></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>\<span class="title">Api</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Requests</span>\<span class="title">Api</span>\<span class="title">VerificationCodeRequest</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Overtrue</span>\<span class="title">EasySms</span>\<span class="title">EasySms</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VerificationCodesController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">store</span><span class="params">(VerificationCodeRequest $request,EasySms $easySms)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//catcha_key中存储 phone 和图片验证码文本</span></span><br><span class="line">        $captchaData = \Cache::get($request-&gt;captcha_key);</span><br><span class="line">        <span class="comment">//验证码是否失效</span></span><br><span class="line">        <span class="keyword">if</span> (!$captchaData) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;response-&gt;error(<span class="string">'图片验证码已失效'</span>,<span class="number">422</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//验证码是否输入正确</span></span><br><span class="line">        <span class="keyword">if</span> (!hash_equals($captchaData[<span class="string">'code'</span>],$request-&gt;captcha_code)) &#123;</span><br><span class="line">            \Cache::forget($request-&gt;captcha_key);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;response-&gt;errorUnauthorized(<span class="string">'验证码错误'</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $phone = $captchaData[<span class="string">'phone'</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!app()-&gt;environment(<span class="string">'production'</span>)) &#123;</span><br><span class="line">            $code = <span class="string">'1234'</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $code = str_pad(random_int(<span class="number">1</span>, <span class="number">9999</span>), <span class="number">4</span>, <span class="number">0</span>, STR_PAD_LEFT);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                 $easySms-&gt;send($phone, [</span><br><span class="line">                    <span class="string">'content'</span> =&gt; <span class="string">"【scottyun】larabbs短信验证码 &#123;$code&#125;，不是本人请忽略"</span></span><br><span class="line">                ]);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (\Overtrue\EasySms\Exceptions\NoGatewayAvailableException $exception) &#123;</span><br><span class="line">                $message = $exception-&gt;getException(<span class="string">'qcloud'</span>)-&gt;getMessage();</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;response-&gt;errorInternal($message ?: <span class="string">'短信发送异常'</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $key = <span class="string">'verificationCode_'</span> . \EasyWeChat\Kernel\Support\str_random(<span class="number">15</span>);</span><br><span class="line">        $expiredAt = now()-&gt;addMinutes(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">        \Cache::put($key, [<span class="string">'phone'</span> =&gt; $phone, <span class="string">'code'</span> =&gt; $code], $expiredAt);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;response-&gt;array([</span><br><span class="line">            <span class="string">'key'</span> =&gt; $key,</span><br><span class="line">            <span class="string">'expired'</span> =&gt; $expiredAt-&gt;toDateString(),</span><br><span class="line">        ])-&gt;setStatusCode(<span class="number">201</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;微信小程序分别使用&lt;strong&gt;手机号&lt;/strong&gt;和&lt;strong&gt;微信&lt;/strong&gt;登录&lt;br&gt;参考：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/overtrue/easy-sms&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;easy-sms&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://learnku.com/courses/laravel-advance-training/5.5/sms-provider/791&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;短信提供商&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://learnku.com/courses/laravel-advance-training/5.8/development-of-mobile-phone-registration-function/3995&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;手机注册验证码&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://learnku.com/courses/laravel-advance-training/5.8/picture-verification-code/3998&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;图片验证码&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&quot;使用手机登录&quot;&gt;&lt;a href=&quot;#使用手机登录&quot; class=&quot;headerlink&quot; title=&quot;使用手机登录&quot;&gt;&lt;/a&gt;使用手机登录&lt;/h2&gt;&lt;h3 id=&quot;发送手机短信&quot;&gt;&lt;a href=&quot;#发送手机短信&quot; class=&quot;headerlink&quot; title=&quot;发送手机短信&quot;&gt;&lt;/a&gt;发送手机短信&lt;/h3&gt;&lt;h4 id=&quot;安装easy-sms&quot;&gt;&lt;a href=&quot;#安装easy-sms&quot; class=&quot;headerlink&quot; title=&quot;安装easy-sms&quot;&gt;&lt;/a&gt;安装easy-sms&lt;/h4&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ composer require &lt;span class=&quot;string&quot;&gt;&quot;overtrue/easy-sms&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# config中添加easysms.php 配置文件&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;$ touch config/easysms.php&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="Tech" scheme="http://yoursite.com/categories/Tech/"/>
    
    
      <category term="laravel" scheme="http://yoursite.com/tags/laravel/"/>
    
      <category term="api" scheme="http://yoursite.com/tags/api/"/>
    
      <category term="微信小程序" scheme="http://yoursite.com/tags/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F/"/>
    
  </entry>
  
  <entry>
    <title>Laravel Passport</title>
    <link href="http://yoursite.com/2019/06/01/Laravel-Passport/"/>
    <id>http://yoursite.com/2019/06/01/Laravel-Passport/</id>
    <published>2019-06-01T02:41:17.000Z</published>
    <updated>2019-06-01T23:32:18.621Z</updated>
    
    <content type="html"><![CDATA[<h2 id="使用Laravel-Passport-实现api用户认证"><a href="#使用Laravel-Passport-实现api用户认证" class="headerlink" title="使用Laravel Passport 实现api用户认证"></a>使用Laravel Passport 实现api用户认证</h2><p>参考：</p><ul><li><a href="https://learnku.com/laravel/t/22586#db06c7" target="_blank" rel="noopener">使用Laravel Passport</a></li></ul><h3 id="Passport配置"><a href="#Passport配置" class="headerlink" title="Passport配置"></a>Passport配置</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">composer <span class="keyword">require</span> laravel/passport</span><br><span class="line"></span><br><span class="line"><span class="comment">//表迁移，生成oauth相关的表</span></span><br><span class="line">php artisan migrate</span><br><span class="line"></span><br><span class="line">php artisan passport:install</span><br></pre></td></tr></table></figure><a id="more"></a><p><em>app/User.php</em><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">use</span> <span class="title">Laravel</span>\<span class="title">Passport</span>\<span class="title">HasApiTokens</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Authenticatable</span> </span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">Notifiable</span>,<span class="title">HasApiTokens</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>引入 <strong>HasApiTokens</strong></p><p><em>app/Providers/AuthServiceProvider.php</em><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Providers</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Facades</span>\<span class="title">Gate</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Support</span>\<span class="title">Providers</span>\<span class="title">AuthServiceProvider</span> <span class="title">as</span> <span class="title">ServiceProvider</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Laravel</span>\<span class="title">Passport</span>\<span class="title">Passport</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AuthServiceProvider</span> <span class="keyword">extends</span> <span class="title">ServiceProvider</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The policy mappings for the application.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $policies = [</span><br><span class="line">         <span class="string">'App\Model'</span> =&gt; <span class="string">'App\Policies\ModelPolicy'</span>,</span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Register any authentication / authorization services.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;registerPolicies();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//引入Ppassport routes,</span></span><br><span class="line">        <span class="comment">//注册必要的路由去颁发访问令牌，撤销访问令牌，客户端和个人令牌</span></span><br><span class="line">        Passport::routes();</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><em>config/auth.php</em><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'api'</span> =&gt; [</span><br><span class="line">    <span class="comment">//driver 改为passport</span></span><br><span class="line">    <span class="string">'driver'</span> =&gt; <span class="string">'passport'</span>,</span><br><span class="line">    <span class="string">'provider'</span> =&gt; <span class="string">'users'</span>,</span><br><span class="line">    <span class="string">'hash'</span> =&gt; <span class="keyword">false</span>,</span><br><span class="line">],</span><br></pre></td></tr></table></figure></p><h3 id="添加api-路由"><a href="#添加api-路由" class="headerlink" title="添加api 路由"></a>添加api 路由</h3><p><em>routes/api.php</em><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">Route::group([</span><br><span class="line">    <span class="string">'prefix'</span> =&gt; <span class="string">'auth'</span></span><br><span class="line">], <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    Route::post(<span class="string">'login'</span>, <span class="string">'AuthController@login'</span>);</span><br><span class="line">    Route::post(<span class="string">'signup'</span>, <span class="string">'AuthController@signup'</span>);</span><br><span class="line"></span><br><span class="line">    Route::group([</span><br><span class="line">      <span class="string">'middleware'</span> =&gt; <span class="string">'auth:api'</span></span><br><span class="line">    ], <span class="function"><span class="keyword">function</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Route::get(<span class="string">'logout'</span>, <span class="string">'AuthController@logout'</span>);</span><br><span class="line">        Route::get(<span class="string">'user'</span>, <span class="string">'AuthController@user'</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p><h3 id="创建控制器"><a href="#创建控制器" class="headerlink" title="创建控制器"></a>创建控制器</h3><p><em>app/Http/Controllers/AuthController.php</em></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">User</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Carbon</span>\<span class="title">Carbon</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Auth</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Facades</span>\<span class="title">Log</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AuthController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">signup</span><span class="params">(Request $request)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $request-&gt;validate([</span><br><span class="line">            <span class="string">'name'</span> =&gt; <span class="string">'required|string'</span>,</span><br><span class="line">            <span class="string">'email'</span> =&gt; <span class="string">'required|string|email'</span>,</span><br><span class="line">            <span class="string">'password'</span> =&gt; <span class="string">'required|string'</span>,</span><br><span class="line">        ]);</span><br><span class="line"></span><br><span class="line">        $user = <span class="keyword">new</span> User([</span><br><span class="line">            <span class="string">'name'</span>=&gt;$request-&gt;name,</span><br><span class="line">            <span class="string">'email'</span>=&gt;$request-&gt;email,</span><br><span class="line">            <span class="string">'password'</span>=&gt;bcrypt($request-&gt;password)</span><br><span class="line">        ]);</span><br><span class="line"></span><br><span class="line">        $user-&gt;save();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> response()-&gt;json([</span><br><span class="line">            <span class="string">'message'</span>=&gt;<span class="string">'create user success'</span></span><br><span class="line">        ],<span class="number">201</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span><span class="params">(Request $request)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $request-&gt;validate([</span><br><span class="line">            <span class="string">'email'</span> =&gt; <span class="string">'required|string|email'</span>,</span><br><span class="line">            <span class="string">'password'</span> =&gt; <span class="string">'required|string'</span>,</span><br><span class="line">            <span class="string">'remember'</span> =&gt; <span class="string">'boolean'</span></span><br><span class="line">        ]);</span><br><span class="line"></span><br><span class="line">        $credentials = request([<span class="string">'email'</span>,<span class="string">'password'</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!Auth::attempt($credentials)) &#123;</span><br><span class="line">            <span class="keyword">return</span> response()-&gt;json([</span><br><span class="line">                <span class="string">'message'</span> =&gt; <span class="string">'unauthorized'</span></span><br><span class="line">            ],<span class="number">401</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $user = $request-&gt;user();</span><br><span class="line"></span><br><span class="line">        $tokenResult = $user-&gt;createToken(<span class="string">'Personal Access Token'</span>);</span><br><span class="line">        Log::info($tokenResult);</span><br><span class="line">        $token = $tokenResult-&gt;token;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ($request-&gt;remember_me) &#123;</span><br><span class="line">            $token-&gt;expires_at = Carbon::now()-&gt;addWeeks(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $token-&gt;save();</span><br><span class="line">        <span class="keyword">return</span> response()-&gt;json([</span><br><span class="line">            <span class="string">'access_token'</span> =&gt; $tokenResult-&gt;accessToken,</span><br><span class="line">            <span class="string">'token_type'</span> =&gt; <span class="string">'Bearer'</span>,</span><br><span class="line">            <span class="string">'expires_at'</span> =&gt; Carbon::parse(</span><br><span class="line">                $tokenResult-&gt;token-&gt;expires_at</span><br><span class="line">            )-&gt;toDateTimeString()</span><br><span class="line">        ]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">logout</span><span class="params">(Request $request)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $request-&gt;user()-&gt;token()-&gt;revoke();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> response()-&gt;json([</span><br><span class="line">            <span class="string">'message'</span> =&gt; <span class="string">'logged out'</span></span><br><span class="line">        ]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">user</span><span class="params">(Request $request)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> response()-&gt;json($request-&gt;user());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>public function login(Request $request)</code>中的</p><p><code>$tokenResult = $user-&gt;createToken(&#39;Personal Access Token&#39;);</code></p><p>$tokenResult的数据结构</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;accessToken&quot;:&quot;eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImp0aSI6IjcxNDQyZmVjMzBhNGI3ZWVjMmY2YTMyOTQwYjkyNjkzNzRjNTE1MTNjOWFhMzVlYTY1ODRl......&quot;,</span><br><span class="line">&quot;token&quot;:&#123;&quot;id&quot;:&quot;71442fec30a4b7eec2f6a32940b9269374c51513c9aa35ea6584e051e6e21075f2255c765028a44a&quot;,</span><br><span class="line">&quot;user_id&quot;:52,&quot;client_id&quot;:1,</span><br><span class="line">&quot;name&quot;:&quot;Personal Access Token&quot;,&quot;scopes&quot;:[],&quot;revoked&quot;:false,&quot;created_at&quot;:&quot;2019-06-01 02:30:45&quot;,&quot;updated_at&quot;:&quot;2019-06-01 02:30:45&quot;,</span><br><span class="line">&quot;expires_at&quot;:&quot;2020-06-01 02:30:45&quot;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>public function logout(Request $request)</code>调用<br><code>$request-&gt;user()-&gt;token()-&gt;revoke();</code><br>注销用户</p><h3 id="Postman测试"><a href="#Postman测试" class="headerlink" title="Postman测试"></a>Postman测试</h3><p><a href="https://app.getpostman.com/run-collection/f22c66cf3d144b138982" target="_blank" rel="noopener">Run in Postman</a><br>其中的form.test改为自己的项目域名。</p><p>signup<br><strong>Headers</strong> 设置<br><code>Content-Type:application/json</code><br><code>X-Requested-With:XMLHttpRequest</code><br><img src="http://ww2.sinaimg.cn/large/006tNc79gy1g3m03alns3j31hs0u0ad7.jpg" alt="sigup"></p><p>login<br><img src="http://ww4.sinaimg.cn/large/006tNc79gy1g3mg8932yfj30s60f7gml.jpg" alt="Login"></p><p>logout<br><img src="http://ww4.sinaimg.cn/large/006tNc79gy1g3mgadyp8oj30s80dpglw.jpg" alt="logout"></p><p>user<br><img src="http://ww1.sinaimg.cn/large/006tNc79gy1g3mgbgfwbqj30rq0e8t92.jpg" alt="user"></p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;使用Laravel-Passport-实现api用户认证&quot;&gt;&lt;a href=&quot;#使用Laravel-Passport-实现api用户认证&quot; class=&quot;headerlink&quot; title=&quot;使用Laravel Passport 实现api用户认证&quot;&gt;&lt;/a&gt;使用Laravel Passport 实现api用户认证&lt;/h2&gt;&lt;p&gt;参考：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://learnku.com/laravel/t/22586#db06c7&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;使用Laravel Passport&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;Passport配置&quot;&gt;&lt;a href=&quot;#Passport配置&quot; class=&quot;headerlink&quot; title=&quot;Passport配置&quot;&gt;&lt;/a&gt;Passport配置&lt;/h3&gt;&lt;figure class=&quot;highlight php&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;composer &lt;span class=&quot;keyword&quot;&gt;require&lt;/span&gt; laravel/passport&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//表迁移，生成oauth相关的表&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;php artisan migrate&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;php artisan passport:install&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="Tech" scheme="http://yoursite.com/categories/Tech/"/>
    
    
      <category term="laravel" scheme="http://yoursite.com/tags/laravel/"/>
    
      <category term="passport" scheme="http://yoursite.com/tags/passport/"/>
    
      <category term="api" scheme="http://yoursite.com/tags/api/"/>
    
  </entry>
  
  <entry>
    <title>laravel factories</title>
    <link href="http://yoursite.com/2019/05/26/laravel-factories/"/>
    <id>http://yoursite.com/2019/05/26/laravel-factories/</id>
    <published>2019-05-26T00:56:14.000Z</published>
    <updated>2019-05-27T13:32:37.814Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Laravel-数据填充"><a href="#Laravel-数据填充" class="headerlink" title="Laravel 数据填充"></a>Laravel 数据填充</h2><p>参考：</p><ul><li><a href="https://learnku.com/courses/laravel-intermediate-training/5.8/seeding-data/4163" target="_blank" rel="noopener">假数据填充</a></li><li><a href="https://learnku.com/docs/laravel/5.8/seeding/3929" target="_blank" rel="noopener">数据填充</a></li><li><a href="https://learnku.com/docs/laravel/5.8/database-testing/3940#writing-factories" target="_blank" rel="noopener">模型工厂</a></li><li><a href="https://scotch.io/@wisdomanthoni/make-your-laravel-seeder-using-model-factories" target="_blank" rel="noopener">make-your-laravel-seeder-using-model-factories</a></li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//文件名单数</span></span><br><span class="line">php artisan make:factory ThreadFactory --model=Thread</span><br><span class="line">php artisan make:factory ReplyFactory --model=Reply</span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="创建模型工厂文件"><a href="#创建模型工厂文件" class="headerlink" title="创建模型工厂文件"></a>创建模型工厂文件</h3><p>database/factories/UserFactory.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/** <span class="doctag">@var</span> \Illuminate\Database\Eloquent\Factory $factory */</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">User</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Support</span>\<span class="title">Str</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Faker</span>\<span class="title">Generator</span> <span class="title">as</span> <span class="title">Faker</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">|--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">| Model Factories</span></span><br><span class="line"><span class="comment">|--------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">|</span></span><br><span class="line"><span class="comment">| This directory should contain each of the model factory definitions for</span></span><br><span class="line"><span class="comment">| your application. Factories provide a convenient way to generate new</span></span><br><span class="line"><span class="comment">| model instances for testing / seeding your application's database.</span></span><br><span class="line"><span class="comment">|</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">$factory-&gt;define(User::class, <span class="function"><span class="keyword">function</span> <span class="params">(Faker $faker)</span> </span>&#123;</span><br><span class="line"><span class="comment">//bcrtpy消耗cpu的函数，静态变量不用每次重新计算</span></span><br><span class="line">    <span class="keyword">static</span> $password;</span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">        <span class="string">'name'</span> =&gt; $faker-&gt;name,</span><br><span class="line">        <span class="string">'email'</span> =&gt; $faker-&gt;unique()-&gt;safeEmail,</span><br><span class="line">        <span class="string">'email_verified_at'</span> =&gt; now(),</span><br><span class="line">        <span class="string">'password'</span> =&gt; $password ?: $password = bcrypt(<span class="string">'123456'</span>), <span class="comment">// password</span></span><br><span class="line">        <span class="string">'remember_token'</span> =&gt; Str::random(<span class="number">10</span>),</span><br><span class="line">    ];</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p><p>database/factories/ThreadFactory.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* <span class="doctag">@var</span> $factory \Illuminate\Database\Eloquent\Factory */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Thread</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Faker</span>\<span class="title">Generator</span> <span class="title">as</span> <span class="title">Faker</span>;</span><br><span class="line"></span><br><span class="line">$factory-&gt;define(Thread::class, <span class="function"><span class="keyword">function</span> <span class="params">(Faker $faker)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">        <span class="comment">//user_id字段在seeder文件中处理</span></span><br><span class="line">        <span class="string">'title'</span>=&gt;$faker-&gt;sentence,</span><br><span class="line">        <span class="string">'body'</span>=&gt;$faker-&gt;paragraph,</span><br><span class="line">    ];</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p><p>database/factories/ReplyFactory.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* <span class="doctag">@var</span> $factory \Illuminate\Database\Eloquent\Factory */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Reply</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Faker</span>\<span class="title">Generator</span> <span class="title">as</span> <span class="title">Faker</span>;</span><br><span class="line"></span><br><span class="line">$factory-&gt;define(Reply::class, <span class="function"><span class="keyword">function</span> <span class="params">(Faker $faker)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">    <span class="comment">//user_id,thread_id在seeder中处理</span></span><br><span class="line">        <span class="string">'body'</span>=&gt;$faker-&gt;paragraph,</span><br><span class="line">    ];</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p><h3 id="创建数据填充文件"><a href="#创建数据填充文件" class="headerlink" title="创建数据填充文件"></a>创建数据填充文件</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//文件名复数</span></span><br><span class="line">php artisan make:seed UsersTableSeeder</span><br><span class="line">php artisan make:seed ThreadsTableSeeder</span><br></pre></td></tr></table></figure><p>database/seeds/UsrsTableSeeder<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Seeder</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">User</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UsersTableSeeder</span> <span class="keyword">extends</span> <span class="title">Seeder</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Run the database seeds.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">       factory(User::class,<span class="number">50</span>)-&gt;create();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>database/seeds/TreadsTableSeeder</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Seeder</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Thread</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ThreadsTableSeeder</span> <span class="keyword">extends</span> <span class="title">Seeder</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Run the database seeds.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//取得所有的用户id，转换为数组</span></span><br><span class="line">        $user_ids =\App\User::all()-&gt;pluck(<span class="string">'id'</span>)-&gt;toArray();</span><br><span class="line">        $faker = app(Faker\Generator::class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//make() method return collection,collection is in memory</span></span><br><span class="line">        $threads = factory(<span class="string">'App\Thread'</span>,<span class="number">90</span>)-&gt;make()-&gt;each(<span class="function"><span class="keyword">function</span> <span class="params">($thread)</span> <span class="title">use</span><span class="params">($user_ids,$faker)</span></span>&#123;</span><br><span class="line">            $thread-&gt;user_id = $faker-&gt;randomElement($user_ids);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//store to database</span></span><br><span class="line">        Thread::insert($threads-&gt;toArray());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>database/seeds/RepliesTableSeeder</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Seeder</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">User</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Thread</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Reply</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RepliesTableSeeder</span> <span class="keyword">extends</span> <span class="title">Seeder</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Run the database seeds.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $user_ids = User::all()-&gt;pluck(<span class="string">'id'</span>)-&gt;toArray();</span><br><span class="line">        $faker = app(Faker\Generator::class);</span><br><span class="line">        $thread_ids = Thread::all()-&gt;pluck(<span class="string">'id'</span>)-&gt;toArray();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//collection</span></span><br><span class="line">        $replies = factory(<span class="string">'App\Reply'</span>,<span class="number">100</span>)-&gt;make()-&gt;each(<span class="function"><span class="keyword">function</span> <span class="params">($reply)</span> <span class="title">use</span><span class="params">($user_ids,$thread_ids,$faker)</span></span>&#123;</span><br><span class="line">           $reply-&gt;user_id = $faker-&gt;randomElement($user_ids);</span><br><span class="line">           $reply-&gt;thread_id = $faker-&gt;randomElement($thread_ids);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        Reply::insert($replies-&gt;toArray());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="运行-Seeders"><a href="#运行-Seeders" class="headerlink" title="运行 Seeders"></a>运行 Seeders</h3><p>重新生成composer的加载器<br><code>composer dump-autoload</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">php artisan db:seed</span><br><span class="line">//运行特定的seeder</span><br><span class="line">php artisan db:seed --class=UsersTableSeeder</span><br></pre></td></tr></table></figure><p><code>migrate:refresh</code> 这个命令来填充数据库，该命令会回滚并重新运行所有迁移。这个命令可以用来重建数据库：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php artisan migrate:refresh --seed</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;Laravel-数据填充&quot;&gt;&lt;a href=&quot;#Laravel-数据填充&quot; class=&quot;headerlink&quot; title=&quot;Laravel 数据填充&quot;&gt;&lt;/a&gt;Laravel 数据填充&lt;/h2&gt;&lt;p&gt;参考：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://learnku.com/courses/laravel-intermediate-training/5.8/seeding-data/4163&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;假数据填充&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://learnku.com/docs/laravel/5.8/seeding/3929&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;数据填充&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://learnku.com/docs/laravel/5.8/database-testing/3940#writing-factories&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;模型工厂&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://scotch.io/@wisdomanthoni/make-your-laravel-seeder-using-model-factories&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;make-your-laravel-seeder-using-model-factories&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;figure class=&quot;highlight php&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;//文件名单数&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;php artisan make:factory ThreadFactory --model=Thread&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;php artisan make:factory ReplyFactory --model=Reply&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="Tech" scheme="http://yoursite.com/categories/Tech/"/>
    
    
      <category term="laravel" scheme="http://yoursite.com/tags/laravel/"/>
    
      <category term="seeder" scheme="http://yoursite.com/tags/seeder/"/>
    
  </entry>
  
  <entry>
    <title>Hexo Blog</title>
    <link href="http://yoursite.com/2019/05/19/Hexo-Blog/"/>
    <id>http://yoursite.com/2019/05/19/Hexo-Blog/</id>
    <published>2019-05-19T10:56:53.000Z</published>
    <updated>2020-04-20T13:10:47.010Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Hexo-博客的搭建"><a href="#Hexo-博客的搭建" class="headerlink" title="Hexo 博客的搭建"></a>Hexo 博客的搭建</h2><p>参考：</p><ul><li><a href="https://hexo.io/zh-cn/" target="_blank" rel="noopener">Hexo</a></li><li><a href="https://www.liaoxuefeng.com/wiki/896043488029600/900375748016320" target="_blank" rel="noopener">git多人协作</a></li><li><a href="http://theme-next.iissnan.com/" target="_blank" rel="noopener">theme nexT</a></li><li><a href="https://github.com/theme-next/hexo-theme-next" target="_blank" rel="noopener">theme nexT github</a></li></ul><h3 id="安装前提"><a href="#安装前提" class="headerlink" title="安装前提"></a>安装前提</h3><ul><li>Node.js</li><li>git</li></ul><p><code>npm install -g hexo-cli</code><br><a id="more"></a></p><h3 id="建站"><a href="#建站" class="headerlink" title="建站"></a>建站</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ hexo init &lt;folder&gt;</span><br><span class="line">$ <span class="built_in">cd</span> &lt;folder&gt;</span><br><span class="line">$ npm install</span><br></pre></td></tr></table></figure><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>__config.yml<br><a href="https://hexo.io/zh-cn/docs/configuration" target="_blank" rel="noopener">详细配置</a></p><h3 id="nexT主题安装"><a href="#nexT主题安装" class="headerlink" title="nexT主题安装"></a>nexT主题安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://github.com/theme-next/hexo-theme-next themes/next</span><br></pre></td></tr></table></figure><p><code>theme: next</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动本地服务器，预览</span></span><br><span class="line">$ hexo s</span><br></pre></td></tr></table></figure><h3 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 推送到 dev远程分支</span></span><br><span class="line">$ git push origin dev</span><br><span class="line"></span><br><span class="line">$ git checkout -b branch-name origin/branch-name</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除分支</span></span><br><span class="line">$ git branch -d (branchname)</span><br></pre></td></tr></table></figure><p>__config.yml<br>部署到主分支<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">deploy:</span></span><br><span class="line"><span class="attr">  type:</span> <span class="string">git</span></span><br><span class="line">  <span class="comment"># repo: https://gh_token@github.com/Scott-feng/scott-feng.github.io.git</span></span><br><span class="line"><span class="attr">  repo:</span> <span class="string">git@github.com:Scott-feng/scott-feng.github.io.git</span></span><br><span class="line"><span class="attr">  branch:</span> <span class="string">master</span></span><br></pre></td></tr></table></figure></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ hexo clean </span><br><span class="line">$ hexo g</span><br><span class="line">$ hexo d</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;Hexo-博客的搭建&quot;&gt;&lt;a href=&quot;#Hexo-博客的搭建&quot; class=&quot;headerlink&quot; title=&quot;Hexo 博客的搭建&quot;&gt;&lt;/a&gt;Hexo 博客的搭建&lt;/h2&gt;&lt;p&gt;参考：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://hexo.io/zh-cn/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Hexo&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://www.liaoxuefeng.com/wiki/896043488029600/900375748016320&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;git多人协作&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://theme-next.iissnan.com/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;theme nexT&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/theme-next/hexo-theme-next&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;theme nexT github&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;安装前提&quot;&gt;&lt;a href=&quot;#安装前提&quot; class=&quot;headerlink&quot; title=&quot;安装前提&quot;&gt;&lt;/a&gt;安装前提&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;Node.js&lt;/li&gt;
&lt;li&gt;git&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;code&gt;npm install -g hexo-cli&lt;/code&gt;&lt;br&gt;
    
    </summary>
    
      <category term="Tech" scheme="http://yoursite.com/categories/Tech/"/>
    
    
      <category term="hexo" scheme="http://yoursite.com/tags/hexo/"/>
    
  </entry>
  
  <entry>
    <title>Laravel Notifications toDatabase</title>
    <link href="http://yoursite.com/2019/05/18/Laravel-Notifications-toDatabase/"/>
    <id>http://yoursite.com/2019/05/18/Laravel-Notifications-toDatabase/</id>
    <published>2019-05-17T23:51:22.000Z</published>
    <updated>2019-05-19T08:08:07.755Z</updated>
    
    <content type="html"><![CDATA[<p>参考:<br><a href="https://learnku.com/docs/laravel/5.8/notifications/3921" target="_blank" rel="noopener">消息通知</a></p><h3 id="Prepare-notification-database"><a href="#Prepare-notification-database" class="headerlink" title="Prepare notification database"></a>Prepare notification database</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">php artisan notifications:table</span><br><span class="line">php artisan migrate</span><br><span class="line"></span><br><span class="line"><span class="comment">#add users table notification_count column</span></span><br><span class="line">php artisan make:migration add_notification_count_to_users_table --table=users</span><br></pre></td></tr></table></figure><h3 id="Generate-notification-class"><a href="#Generate-notification-class" class="headerlink" title="Generate notification class"></a>Generate notification class</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php artisan make:notification</span><br></pre></td></tr></table></figure><a id="more"></a><p>app/Notifications/TopicReplied</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Notifications</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Bus</span>\<span class="title">Queueable</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Notifications</span>\<span class="title">Notification</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">Queue</span>\<span class="title">ShouldQueue</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Notifications</span>\<span class="title">Messages</span>\<span class="title">MailMessage</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Models</span>\<span class="title">Message</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Auth</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TopicReplied</span> <span class="keyword">extends</span> <span class="title">Notification</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">Queueable</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create a new notification instance.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> $message;</span><br><span class="line">    <span class="keyword">public</span> $topic;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(Message $message)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;message = $message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the notification's delivery channels.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  mixed  $notifiable</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">via</span><span class="params">($notifiable)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> [<span class="string">'database'</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the array representation of the notification.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  mixed  $notifiable</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">toArray</span><span class="params">($notifiable)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            <span class="string">'from'</span>=&gt;Auth::user()-&gt;name,</span><br><span class="line">            <span class="string">'message'</span>=&gt;<span class="keyword">$this</span>-&gt;message-&gt;content,</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Get-all-notifications-use-Notifiable-trait"><a href="#Get-all-notifications-use-Notifiable-trait" class="headerlink" title="Get all notifications,use Notifiable trait"></a>Get all notifications,use Notifiable trait</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$notifications = $user-&gt;notifications()-&gt;paginate(<span class="number">20</span>);</span><br><span class="line"><span class="comment"># get the serialize data by toArray() method</span></span><br><span class="line">$notification-&gt;data toArray() data</span><br><span class="line"></span><br><span class="line">$user-&gt;notify(<span class="keyword">new</span> TopicReplied($message))</span><br></pre></td></tr></table></figure><h3 id="MarkAsRead"><a href="#MarkAsRead" class="headerlink" title="MarkAsRead"></a>MarkAsRead</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$user-&gt;unreadNotifications-&gt;markAsRead();</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;参考:&lt;br&gt;&lt;a href=&quot;https://learnku.com/docs/laravel/5.8/notifications/3921&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;消息通知&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;Prepare-notification-database&quot;&gt;&lt;a href=&quot;#Prepare-notification-database&quot; class=&quot;headerlink&quot; title=&quot;Prepare notification database&quot;&gt;&lt;/a&gt;Prepare notification database&lt;/h3&gt;&lt;figure class=&quot;highlight php&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;php artisan notifications:table&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;php artisan migrate&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;#add users table notification_count column&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;php artisan make:migration add_notification_count_to_users_table --table=users&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;Generate-notification-class&quot;&gt;&lt;a href=&quot;#Generate-notification-class&quot; class=&quot;headerlink&quot; title=&quot;Generate notification class&quot;&gt;&lt;/a&gt;Generate notification class&lt;/h3&gt;&lt;figure class=&quot;highlight php&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;php artisan make:notification&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="Tech" scheme="http://yoursite.com/categories/Tech/"/>
    
    
      <category term="laravel" scheme="http://yoursite.com/tags/laravel/"/>
    
      <category term="notifications" scheme="http://yoursite.com/tags/notifications/"/>
    
  </entry>
  
  <entry>
    <title>ElasticSearch highlight</title>
    <link href="http://yoursite.com/2019/05/18/ElasticSearch-highlight/"/>
    <id>http://yoursite.com/2019/05/18/ElasticSearch-highlight/</id>
    <published>2019-05-17T23:36:51.000Z</published>
    <updated>2019-05-17T23:47:27.130Z</updated>
    
    <content type="html"><![CDATA[<p>Laravel Scout ElasticSearch搜索的基础上，搜索到的关键词加高亮的效果。<br>参考：<br><a href="https://learnku.com/articles/4038/tutorial-two-write-a-search-solve-the-search-results-highlight-the-problem-using-laravel-scout-elasticsearch-ik-word-segmentation" target="_blank" rel="noopener">搜索结果高亮</a><br><a href="https://learnku.com/docs/laravel/5.8/scout/3946" target="_blank" rel="noopener">Scout</a></p><h3 id="自定义搜索引擎"><a href="#自定义搜索引擎" class="headerlink" title="自定义搜索引擎"></a>自定义搜索引擎</h3><a id="more"></a><p>App\Services\EsEngine.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Services</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Laravel</span>\<span class="title">Scout</span>\<span class="title">Builder</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">ScoutEngines</span>\<span class="title">Elasticsearch</span>\<span class="title">ElasticsearchEngine</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Database</span>\<span class="title">Eloquent</span>\<span class="title">Collection</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EsEngine</span> <span class="keyword">extends</span> <span class="title">ElasticsearchEngine</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">search</span><span class="params">(Builder $builder)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $result =  <span class="keyword">$this</span>-&gt;performSearch($builder, array_filter([</span><br><span class="line">            <span class="string">'numericFilters'</span> =&gt; <span class="keyword">$this</span>-&gt;filters($builder),</span><br><span class="line">            <span class="string">'size'</span> =&gt; $builder-&gt;limit,</span><br><span class="line">        ]));</span><br><span class="line">        <span class="keyword">return</span> $result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Perform the given search on the engine.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  Builder  $builder</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">performSearch</span><span class="params">(Builder $builder, array $options = [])</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    <span class="comment">//定义查询</span></span><br><span class="line">        $params = [</span><br><span class="line">            <span class="string">'index'</span> =&gt; <span class="keyword">$this</span>-&gt;index,</span><br><span class="line">            <span class="string">'type'</span> =&gt; $builder-&gt;model-&gt;searchableAs(),</span><br><span class="line">            <span class="string">'body'</span> =&gt; [</span><br><span class="line">                <span class="string">'query'</span> =&gt; [</span><br><span class="line">                    <span class="string">'bool'</span> =&gt; [</span><br><span class="line">                        <span class="string">'must'</span> =&gt; [</span><br><span class="line">                            [</span><br><span class="line">                                <span class="string">'query_string'</span> =&gt; [</span><br><span class="line">                                    <span class="string">'query'</span> =&gt; <span class="string">"&#123;$builder-&gt;query&#125;"</span>,</span><br><span class="line">                                ]</span><br><span class="line">                            ]</span><br><span class="line">                        ]</span><br><span class="line">                    ]</span><br><span class="line">                ],</span><br><span class="line">            ]</span><br><span class="line">        ];</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 这里使用了 highlight 的配置</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> ($builder-&gt;model-&gt;searchSettings</span><br><span class="line">            &amp;&amp; <span class="keyword">isset</span>($builder-&gt;model-&gt;searchSettings[<span class="string">'attributesToHighlight'</span>])</span><br><span class="line">        ) &#123;</span><br><span class="line">            $attributes = $builder-&gt;model-&gt;searchSettings[<span class="string">'attributesToHighlight'</span>];</span><br><span class="line">            <span class="keyword">foreach</span> ($attributes <span class="keyword">as</span> $attribute) &#123;</span><br><span class="line">                $params[<span class="string">'body'</span>][<span class="string">'highlight'</span>][<span class="string">'fields'</span>][$attribute] = <span class="keyword">new</span> \stdClass();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($options[<span class="string">'from'</span>])) &#123;</span><br><span class="line">            $params[<span class="string">'body'</span>][<span class="string">'from'</span>] = $options[<span class="string">'from'</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($options[<span class="string">'size'</span>])) &#123;</span><br><span class="line">            $params[<span class="string">'body'</span>][<span class="string">'size'</span>] = $options[<span class="string">'size'</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($options[<span class="string">'numericFilters'</span>]) &amp;&amp; count($options[<span class="string">'numericFilters'</span>])) &#123;</span><br><span class="line">            $params[<span class="string">'body'</span>][<span class="string">'query'</span>][<span class="string">'bool'</span>][<span class="string">'must'</span>] = array_merge($params[<span class="string">'body'</span>][<span class="string">'query'</span>][<span class="string">'bool'</span>][<span class="string">'must'</span>],</span><br><span class="line">                $options[<span class="string">'numericFilters'</span>]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;elastic-&gt;search($params);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Map the given results to instances of the given model.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  mixed  $results</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Database\Eloquent\Model  $model</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Collection</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">map</span><span class="params">(Builder $builder, $results, $model)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ($results[<span class="string">'hits'</span>][<span class="string">'total'</span>] === <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Collection::make();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $keys = collect($results[<span class="string">'hits'</span>][<span class="string">'hits'</span>])</span><br><span class="line">            -&gt;pluck(<span class="string">'_id'</span>)-&gt;values()-&gt;all();</span><br><span class="line"></span><br><span class="line">        $models = $model-&gt;getScoutModelsByIds(</span><br><span class="line">            $builder, $keys</span><br><span class="line">        )-&gt;keyBy(<span class="function"><span class="keyword">function</span> <span class="params">($model)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> $model-&gt;getScoutKey();</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> collect($results[<span class="string">'hits'</span>][<span class="string">'hits'</span>])-&gt;map(<span class="function"><span class="keyword">function</span> <span class="params">($hit)</span> <span class="title">use</span> <span class="params">($model, $models)</span> </span>&#123;</span><br><span class="line">            $one = $models[$hit[<span class="string">'_id'</span>]];</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             * 这里返回的数据，如果有 highlight，就把对应的  highlight 设置到对象上面，highlights对应model里定义的属性</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">isset</span>($hit[<span class="string">'highlight'</span>])) &#123;</span><br><span class="line">                $one-&gt;highlights = $hit[<span class="string">'highlight'</span>];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> $one;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="修改Scout的Engine"><a href="#修改Scout的Engine" class="headerlink" title="修改Scout的Engine"></a>修改Scout的Engine</h3><p>config/scout.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'driver'</span> =&gt; env(<span class="string">'SCOUT_DRIVER'</span>, <span class="string">'es'</span>)</span><br></pre></td></tr></table></figure></p><p>app/Providers/AppServiceProvider.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">boot</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        resolve(EngineManager::class)-&gt;extend(<span class="string">'es'</span>, <span class="function"><span class="keyword">function</span><span class="params">($app)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//实例化EsEngine</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> EsEngine(ElasticBuilder::create()</span><br><span class="line">                -&gt;setHosts(config(<span class="string">'scout.elasticsearch.hosts'</span>))</span><br><span class="line">                -&gt;build(),</span><br><span class="line">                config(<span class="string">'scout.elasticsearch.index'</span>)</span><br><span class="line">            );</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p><h3 id="添加属性trait"><a href="#添加属性trait" class="headerlink" title="添加属性trait"></a>添加属性trait</h3><p>  app/Traits/EsSearchable.php<br>  <strong>traits的拼写，查错查了好久</strong><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Traits</span>;</span><br><span class="line"><span class="keyword">trait</span> EsSearchable</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">//query</span></span><br><span class="line">    <span class="keyword">public</span> $searchSettings = [</span><br><span class="line">        <span class="string">'attributesToHighlight'</span> =&gt; [</span><br><span class="line">            <span class="string">'*'</span></span><br><span class="line">        ]</span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">//store highlight results for blade template</span></span><br><span class="line">    <span class="keyword">public</span> $highlight = [];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="model中添加-EsSearchabel-Trait"><a href="#model中添加-EsSearchabel-Trait" class="headerlink" title="model中添加 EsSearchabel Trait"></a>model中添加 EsSearchabel Trait</h3><p>App/Models/Topic.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Traits</span>\<span class="title">EsSearchabel</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">EsSearchabel</span>;</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p><h3 id="添加关键词的样式"><a href="#添加关键词的样式" class="headerlink" title="添加关键词的样式"></a>添加关键词的样式</h3><p>进入<strong>Tinker</strong><br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//结果中带有&lt;em&gt;&lt;/em&gt;标签，对标签设置color属性。</span></span><br><span class="line">$collection = App\Models\Topic::search(<span class="string">"qu"</span>)-&gt;get();</span><br><span class="line">$collection-&gt;first()[<span class="string">'highlights'</span>][<span class="string">'body][0];</span></span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Laravel Scout ElasticSearch搜索的基础上，搜索到的关键词加高亮的效果。&lt;br&gt;参考：&lt;br&gt;&lt;a href=&quot;https://learnku.com/articles/4038/tutorial-two-write-a-search-solve-the-search-results-highlight-the-problem-using-laravel-scout-elasticsearch-ik-word-segmentation&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;搜索结果高亮&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://learnku.com/docs/laravel/5.8/scout/3946&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Scout&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;自定义搜索引擎&quot;&gt;&lt;a href=&quot;#自定义搜索引擎&quot; class=&quot;headerlink&quot; title=&quot;自定义搜索引擎&quot;&gt;&lt;/a&gt;自定义搜索引擎&lt;/h3&gt;
    
    </summary>
    
      <category term="Tech" scheme="http://yoursite.com/categories/Tech/"/>
    
    
      <category term="laravel" scheme="http://yoursite.com/tags/laravel/"/>
    
      <category term="elasticSearch" scheme="http://yoursite.com/tags/elasticSearch/"/>
    
  </entry>
  
  <entry>
    <title>Laravel ElasticSearch Scout</title>
    <link href="http://yoursite.com/2019/05/17/Laravel-ElasticSearch-Scout/"/>
    <id>http://yoursite.com/2019/05/17/Laravel-ElasticSearch-Scout/</id>
    <published>2019-05-17T13:38:01.000Z</published>
    <updated>2019-05-17T23:49:27.738Z</updated>
    
    <content type="html"><![CDATA[<p>Laravel 中使用Elasticsearch 结合Scout,实现全文搜索</p><p>参考:</p><ul><li><a href="https://www.einsition.com/article/7/details" target="_blank" rel="noopener">Laravel Scout+Elastic</a></li><li><a href="https://github.com/ErickTamayo/laravel-scout-elastic" target="_blank" rel="noopener">tamayo/laravel-scout-elastic</a></li></ul><h3 id="安装composer依赖"><a href="#安装composer依赖" class="headerlink" title="安装composer依赖"></a>安装composer依赖</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">composer <span class="keyword">require</span> tamayo/laravel-scout-elastic</span><br><span class="line">composer <span class="keyword">require</span> laravel/scout</span><br></pre></td></tr></table></figure><p>config/app.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'providers'</span> =&gt; [</span><br><span class="line">    ...</span><br><span class="line">    Laravel\Scout\ScoutServiceProvider::class,</span><br><span class="line">    ...</span><br><span class="line">    ScoutEngines\Elasticsearch\ElasticsearchProvider::class,</span><br><span class="line">],</span><br></pre></td></tr></table></figure></p><a id="more"></a><h3 id="配置ElasticSearch"><a href="#配置ElasticSearch" class="headerlink" title="配置ElasticSearch"></a>配置ElasticSearch</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php artisan vendor:publish --provider=<span class="string">"Laravel\Scout\ScoutServiceProvider</span></span><br></pre></td></tr></table></figure><p>config\scout.php配置文件，<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'driver'</span> =&gt; env(<span class="string">'SCOUT_DRIVER'</span>, <span class="string">'elasticsearch'</span>)</span><br></pre></td></tr></table></figure></p><p>.env<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ELASTICSEARCH_INDEX=laravel_index</span><br><span class="line">ELASTICSEARCH_HOST=http:<span class="comment">//localhost</span></span><br></pre></td></tr></table></figure></p><p>config/scout.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//添加elasticsearch配置</span></span><br><span class="line"><span class="string">'elasticsearch'</span> =&gt; [</span><br><span class="line">        <span class="string">'index'</span> =&gt; env(<span class="string">'ELASTICSEARCH_INDEX'</span>, <span class="string">'laravel'</span>),</span><br><span class="line">        <span class="string">'hosts'</span> =&gt; [</span><br><span class="line">            env(<span class="string">'ELASTICSEARCH_HOST'</span>, <span class="string">''</span>),</span><br><span class="line">        ],</span><br><span class="line">    ],</span><br></pre></td></tr></table></figure></p><blockquote><p><strong>Note:</strong> ‘queue’ =&gt; env(‘SCOUT_QUEUE’, false),<br>     不使用queue,php artisan scout:import xxx 能直接看到效果。</p></blockquote><p>  App\Models\Topic.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="comment">//增加Searchable</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">Searchable</span>;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">toSearchableArray</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="keyword">return</span> [</span><br><span class="line">      <span class="string">'title'</span> =&gt; <span class="keyword">$this</span>-&gt;title,</span><br><span class="line">      <span class="string">'content'</span> =&gt; <span class="keyword">$this</span>-&gt;content,</span><br><span class="line">   ];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="创建command-命令"><a href="#创建command-命令" class="headerlink" title="创建command 命令"></a>创建command 命令</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php artisan make:command EsInit</span><br></pre></td></tr></table></figure><p>app\Console\Command\ESInit.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Console</span>\<span class="title">Commands</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">GuzzleHttp</span>\<span class="title">Client</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Console</span>\<span class="title">Command</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ESInit</span> <span class="keyword">extends</span> <span class="title">Command</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * The name and signature of the console command.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@var</span> string</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">protected</span> $signature = <span class="string">'es:init'</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * The console command description.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@var</span> string</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">protected</span> $description = <span class="string">'init laravel es for article'</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Create a new command instance.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">      <span class="keyword">parent</span>::__construct();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Execute the console command.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span><span class="params">(Client $client)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">      <span class="keyword">$this</span>-&gt;createTemplate($client);</span><br><span class="line">      <span class="keyword">$this</span>-&gt;createIndex($client);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 创建模板 see https://www.elastic.co/guide/en/elasticsearch/reference/current/dynamic-templates.html</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> Client $client</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">createTemplate</span><span class="params">(Client $client)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">      $url = config(<span class="string">'scout.elasticsearch.hosts'</span>)[<span class="number">0</span>] . <span class="string">'/_template/template_1'</span>;</span><br><span class="line">      $client-&gt;put($url, [</span><br><span class="line">          <span class="string">'json'</span> =&gt; [</span><br><span class="line">              <span class="string">'template'</span> =&gt; config(<span class="string">'scout.elasticsearch.index'</span>),</span><br><span class="line">              <span class="string">'settings'</span> =&gt; [</span><br><span class="line">                  <span class="string">'number_of_shards'</span> =&gt; <span class="number">1</span>,</span><br><span class="line">              ],</span><br><span class="line">              <span class="string">'mappings'</span> =&gt; [</span><br><span class="line">                  <span class="string">'_default_'</span> =&gt; [</span><br><span class="line">                      <span class="string">'dynamic_templates'</span> =&gt; [ <span class="comment">// 动态映射模板</span></span><br><span class="line">                          [</span><br><span class="line">                              <span class="string">'string_fields'</span> =&gt; [ <span class="comment">// 字段映射模板的名称，一般为"类型_fields"的命名方式</span></span><br><span class="line">                                  <span class="string">'match'</span> =&gt; <span class="string">'*'</span>, <span class="comment">// 匹配的字段名为所有</span></span><br><span class="line">                                  <span class="string">'match_mapping_type'</span> =&gt; <span class="string">'string'</span>, <span class="comment">// 限制匹配的字段类型，只能是 string 类型</span></span><br><span class="line">                                  <span class="string">'mapping'</span> =&gt; [ <span class="comment">// 字段的处理方式</span></span><br><span class="line">                                      <span class="string">'type'</span> =&gt; <span class="string">'text'</span>, <span class="comment">// 字段类型限定为 string</span></span><br><span class="line">                                      <span class="string">'analyzer'</span> =&gt; <span class="string">'ik_smart'</span>, <span class="comment">// 字段采用的分析器名，默认值为 standard 分析器</span></span><br><span class="line">                                      <span class="string">'fields'</span> =&gt; [</span><br><span class="line">                                          <span class="string">'raw'</span> =&gt; [</span><br><span class="line">                                              <span class="string">'type'</span> =&gt; <span class="string">'keyword'</span>,</span><br><span class="line">                                              <span class="string">'ignore_above'</span> =&gt; <span class="number">256</span>, <span class="comment">// 字段是索引时忽略长度超过定义值的字段。</span></span><br><span class="line">                                          ]</span><br><span class="line">                                      ],</span><br><span class="line">                                  ],</span><br><span class="line">                              ],</span><br><span class="line">                          ],</span><br><span class="line">                      ],</span><br><span class="line">                  ],</span><br><span class="line">              ],</span><br><span class="line">          ],</span><br><span class="line">      ]);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">$this</span>-&gt;info(<span class="string">"=======创建模板成功======="</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">createIndex</span><span class="params">(Client $client)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">      $url = config(<span class="string">'scout.elasticsearch.hosts'</span>)[<span class="number">0</span>] . <span class="string">'/'</span> . config(<span class="string">'scout.elasticsearch.index'</span>);</span><br><span class="line"></span><br><span class="line">      $client-&gt;put($url, [</span><br><span class="line">          <span class="string">'json'</span> =&gt; [</span><br><span class="line">              <span class="string">'settings'</span> =&gt; [</span><br><span class="line">                  <span class="string">'refresh_interval'</span> =&gt; <span class="string">'5s'</span>,</span><br><span class="line">                  <span class="string">'number_of_shards'</span> =&gt; <span class="number">1</span>, <span class="comment">// 分片为</span></span><br><span class="line">                  <span class="string">'number_of_replicas'</span> =&gt; <span class="number">0</span>, <span class="comment">// 副本数</span></span><br><span class="line">              ],</span><br><span class="line">              <span class="string">'mappings'</span> =&gt; [</span><br><span class="line">                  <span class="string">'_default_'</span> =&gt; [</span><br><span class="line">                      <span class="string">'_all'</span> =&gt; [</span><br><span class="line">                          <span class="string">'enabled'</span> =&gt; <span class="keyword">false</span>, <span class="comment">// 是否开启所有字段的检索</span></span><br><span class="line">                      ],</span><br><span class="line">                  ],</span><br><span class="line">              ],</span><br><span class="line">          ],</span><br><span class="line">      ]);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">$this</span>-&gt;info(<span class="string">"=========创建索引成功========="</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="执行command导入数据"><a href="#执行command导入数据" class="headerlink" title="执行command导入数据"></a>执行command导入数据</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">php artisan es:init</span><br><span class="line"></span><br><span class="line"><span class="comment">//导入数据</span></span><br><span class="line">php artisan scout:import <span class="string">"App\Models\Topic"</span></span><br></pre></td></tr></table></figure><h3 id="验证template"><a href="#验证template" class="headerlink" title="验证template"></a>验证template</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl localhost:<span class="number">9200</span>/_template/template_1`</span><br><span class="line"></span><br><span class="line">验证导入的数据</span><br><span class="line">curl localhost:<span class="number">9200</span>/laravel_index/_search?pretty</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Laravel 中使用Elasticsearch 结合Scout,实现全文搜索&lt;/p&gt;
&lt;p&gt;参考:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://www.einsition.com/article/7/details&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Laravel Scout+Elastic&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/ErickTamayo/laravel-scout-elastic&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;tamayo/laravel-scout-elastic
&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;安装composer依赖&quot;&gt;&lt;a href=&quot;#安装composer依赖&quot; class=&quot;headerlink&quot; title=&quot;安装composer依赖&quot;&gt;&lt;/a&gt;安装composer依赖&lt;/h3&gt;&lt;figure class=&quot;highlight php&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;composer &lt;span class=&quot;keyword&quot;&gt;require&lt;/span&gt; tamayo/laravel-scout-elastic&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;composer &lt;span class=&quot;keyword&quot;&gt;require&lt;/span&gt; laravel/scout&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;config/app.php&lt;br&gt;&lt;figure class=&quot;highlight php&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;&#39;providers&#39;&lt;/span&gt; =&amp;gt; [&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    Laravel\Scout\ScoutServiceProvider::class,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ...&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;    ScoutEngines\Elasticsearch\ElasticsearchProvider::class,&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;],&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="Tech" scheme="http://yoursite.com/categories/Tech/"/>
    
    
      <category term="laravel" scheme="http://yoursite.com/tags/laravel/"/>
    
      <category term="elasticSearch" scheme="http://yoursite.com/tags/elasticSearch/"/>
    
      <category term="scout" scheme="http://yoursite.com/tags/scout/"/>
    
  </entry>
  
  <entry>
    <title>Hello World</title>
    <link href="http://yoursite.com/2019/05/17/hello-world/"/>
    <id>http://yoursite.com/2019/05/17/hello-world/</id>
    <published>2019-05-16T23:44:31.952Z</published>
    <updated>2019-05-16T23:44:31.953Z</updated>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><a id="more"></a><p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Welcome to &lt;a href=&quot;https://hexo.io/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Hexo&lt;/a&gt;! This is your very first post. Check &lt;a href=&quot;https://hexo.io/docs/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;documentation&lt;/a&gt; for more info. If you get any problems when using Hexo, you can find the answer in &lt;a href=&quot;https://hexo.io/docs/troubleshooting.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;troubleshooting&lt;/a&gt; or you can ask me on &lt;a href=&quot;https://github.com/hexojs/hexo/issues&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;GitHub&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id=&quot;Quick-Start&quot;&gt;&lt;a href=&quot;#Quick-Start&quot; class=&quot;headerlink&quot; title=&quot;Quick Start&quot;&gt;&lt;/a&gt;Quick Start&lt;/h2&gt;&lt;h3 id=&quot;Create-a-new-post&quot;&gt;&lt;a href=&quot;#Create-a-new-post&quot; class=&quot;headerlink&quot; title=&quot;Create a new post&quot;&gt;&lt;/a&gt;Create a new post&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ hexo new &lt;span class=&quot;string&quot;&gt;&quot;My New Post&quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;More info: &lt;a href=&quot;https://hexo.io/docs/writing.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Writing&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;Run-server&quot;&gt;&lt;a href=&quot;#Run-server&quot; class=&quot;headerlink&quot; title=&quot;Run server&quot;&gt;&lt;/a&gt;Run server&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;$ hexo server&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Laravel websockets</title>
    <link href="http://yoursite.com/2019/05/16/Laravel-websockets/"/>
    <id>http://yoursite.com/2019/05/16/Laravel-websockets/</id>
    <published>2019-05-15T23:00:55.000Z</published>
    <updated>2019-05-17T13:33:37.748Z</updated>
    
    <content type="html"><![CDATA[<p>Laravel 配合laravel-echo 使用 websockets</p><p>参考<br><a href="https://docs.beyondco.de/laravel-websockets/" target="_blank" rel="noopener">Laravel Websockets</a><br><a href="https://learnku.com/docs/laravel/5.8/broadcasting/3914" target="_blank" rel="noopener">广播系统</a><br><a href="https://pusher.com/tutorials/chat-laravel" target="_blank" rel="noopener">Build a chat app with laravel</a><br><a id="more"></a></p><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">composer <span class="keyword">require</span> pusher/pusher-php-server <span class="string">"~3.0"</span></span><br><span class="line">composer <span class="keyword">require</span> beyondcode/laravel-websockets</span><br><span class="line">composer <span class="keyword">require</span> predis/predis</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// a migration to store statistic information</span></span><br><span class="line">php artisan vendor:publish --provider=<span class="string">"BeyondCode\LaravelWebSockets\WebSocketsServiceProvider"</span> --tag=<span class="string">"migrations"</span></span><br><span class="line"></span><br><span class="line">php artisan migrate</span><br><span class="line"></span><br><span class="line"><span class="comment">// publish the WebSocket configuration file</span></span><br><span class="line">php artisan vendor:publish --provider=<span class="string">"BeyondCode\LaravelWebSockets\WebSocketsServiceProvider"</span> --tag=<span class="string">"config"</span></span><br></pre></td></tr></table></figure><p>.env</p><blockquote><p>BROADCAST_DRIVER=pusher<br>QUEUE_CONNECTION=sync //设为sync方便调试,生产环境设为redis</p></blockquote><p>config/broadcasting.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'pusher'</span> =&gt; [</span><br><span class="line">    <span class="string">'driver'</span> =&gt; <span class="string">'pusher'</span>,</span><br><span class="line">    <span class="string">'key'</span> =&gt; env(<span class="string">'PUSHER_APP_KEY'</span>),</span><br><span class="line">    <span class="string">'secret'</span> =&gt; env(<span class="string">'PUSHER_APP_SECRET'</span>),</span><br><span class="line">    <span class="string">'app_id'</span> =&gt; env(<span class="string">'PUSHER_APP_ID'</span>),</span><br><span class="line">    <span class="string">'options'</span> =&gt; [</span><br><span class="line">        <span class="string">'cluster'</span> =&gt; env(<span class="string">'PUSHER_APP_CLUSTER'</span>),</span><br><span class="line">        <span class="string">'encrypted'</span> =&gt; <span class="keyword">true</span>,</span><br><span class="line">        <span class="string">'host'</span> =&gt; <span class="string">'127.0.0.1'</span>,</span><br><span class="line">        <span class="string">'port'</span> =&gt; <span class="number">6001</span>,</span><br><span class="line">        <span class="string">'scheme'</span> =&gt; <span class="string">'http'</span></span><br><span class="line">    ],</span><br><span class="line">],</span><br></pre></td></tr></table></figure></p><p>config/app.php</p><blockquote><p>App\Providers\BroadcastServiceProvider::class,</p></blockquote><p><strong>取消注释,否则auth/broadcasting not found 错误</strong></p><h3 id="后端部分"><a href="#后端部分" class="headerlink" title="后端部分"></a>后端部分</h3><blockquote><p>php artisan make:event ExampleEvent</p></blockquote><p>App\Events\ExampleEvent.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Events</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Message</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">User</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Broadcasting</span>\<span class="title">Channel</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Queue</span>\<span class="title">SerializesModels</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Broadcasting</span>\<span class="title">PrivateChannel</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Broadcasting</span>\<span class="title">PresenceChannel</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Events</span>\<span class="title">Dispatchable</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Broadcasting</span>\<span class="title">InteractsWithSockets</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Contracts</span>\<span class="title">Broadcasting</span>\<span class="title">ShouldBroadcast</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MessageSent</span> <span class="keyword">implements</span> <span class="title">ShouldBroadcast</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">Dispatchable</span>, <span class="title">InteractsWithSockets</span>, <span class="title">SerializesModels</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Create a new event instance.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> void</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $user;</span><br><span class="line">    <span class="keyword">public</span> $message;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(User $user,Message $message)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;user = $user;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;message = $message;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the channels the event should broadcast on.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> \Illuminate\Broadcasting\Channel|array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">broadcastOn</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> PrivateChannel(<span class="string">'chat'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>routes/channel.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Broadcast::channel(<span class="string">'chat'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($user)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> \Auth::check();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p><p>使用laravel login 脚手架<br>php artisan make:auth<br><code>protected $redirectTo = &#39;/&#39;;</code><br><strong>Auth/RegisterController,Auth/LoginController Auth/ResetPasswordController</strong></p><p>routes/web.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Auth::routes();</span><br><span class="line"></span><br><span class="line">Route::get(<span class="string">'/'</span>, <span class="string">'ChatsController@index'</span>);</span><br><span class="line">Route::get(<span class="string">'messages'</span>, <span class="string">'ChatsController@fetchMessages'</span>);</span><br><span class="line">Route::post(<span class="string">'messages'</span>, <span class="string">'ChatsController@sendMessage'</span>);</span><br></pre></td></tr></table></figure></p><blockquote><p>php artisan make:controller ChatsController</p></blockquote><p>Controllers/ChatsController<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Events</span>\<span class="title">MessageSent</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">App</span>\<span class="title">Message</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Auth</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChatsController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;middleware(<span class="string">'auth'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> view(<span class="string">'chat'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Message</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">fetchMessages</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Message::with(<span class="string">'user'</span>)-&gt;get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> Request $request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sendMessage</span><span class="params">(Request $request)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $user = Auth::user();</span><br><span class="line"></span><br><span class="line">        $message = $user-&gt;messages()-&gt;create([</span><br><span class="line">           <span class="string">'message'</span>=&gt;$request-&gt;input(<span class="string">'message'</span>)</span><br><span class="line">        ]);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//只广播给其他人</span></span><br><span class="line">        broadcast(<span class="keyword">new</span> MessageSent($user,$message))-&gt;toOthers();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> [<span class="string">'status'</span>=&gt;<span class="string">'Message sent!'</span>];</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="安装前端依赖"><a href="#安装前端依赖" class="headerlink" title="安装前端依赖"></a>安装前端依赖</h3><blockquote><p>npm install –save laravel-echo pusher-js</p></blockquote><p>bootstrap.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Echo <span class="keyword">from</span> <span class="string">"laravel-echo"</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">window</span>.Pusher = <span class="built_in">require</span>(<span class="string">'pusher-js'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">window</span>.Echo = <span class="keyword">new</span> Echo(&#123;</span><br><span class="line">    broadcaster: <span class="string">'pusher'</span>,</span><br><span class="line">    key: <span class="string">'b540cc10ff9a76b8ee18'</span>, <span class="comment">//your pusher key</span></span><br><span class="line">    wsHost: <span class="built_in">window</span>.location.hostname,</span><br><span class="line">    wsPort: <span class="number">6001</span>,</span><br><span class="line">    disableStats: <span class="literal">true</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p><p>app.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.Echo.private(<span class="string">'chat'</span>)</span><br><span class="line">            .listen(<span class="string">'MessageSent'</span>,(e)=&gt;&#123;</span><br><span class="line">               <span class="keyword">this</span>.messages.push(&#123;</span><br><span class="line">                    message: e.message.message,</span><br><span class="line">                    user: e.user</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;);</span><br></pre></td></tr></table></figure></p><p>增加wsHost,wsPort 指向Laravel WebSocket server。</p><blockquote><p>npm run watch</p></blockquote><p>编译css,js</p><h3 id="启动WebSocket-server"><a href="#启动WebSocket-server" class="headerlink" title="启动WebSocket server"></a>启动WebSocket server</h3><blockquote><p>php artisan websockets:serve</p></blockquote><h3 id="Debugging"><a href="#Debugging" class="headerlink" title="Debugging"></a>Debugging</h3><p><a href="http://tasks.test/laravel-websockets" target="_blank" rel="noopener">http://tasks.test/laravel-websockets</a></p><p>总结：<br>1.后端生成事件，依赖注入要发送的对象。<br>2.使用broadcast()方法广播事件<br>3.前端Echo接收频道以及频道的特定事件。</p><p>Note:</p><ul><li>使用队列处理事件，启动php artisan queue:work,调试的时候QUEUE_DRIVER= sync</li><li>前端更改代码，npm run watch，刷新后看到效果</li><li>App\Providers\BroadcastServiceProvider::class要取消注释。</li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Laravel 配合laravel-echo 使用 websockets&lt;/p&gt;
&lt;p&gt;参考&lt;br&gt;&lt;a href=&quot;https://docs.beyondco.de/laravel-websockets/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Laravel Websockets&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://learnku.com/docs/laravel/5.8/broadcasting/3914&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;广播系统&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;https://pusher.com/tutorials/chat-laravel&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Build a chat app with laravel&lt;/a&gt;&lt;br&gt;
    
    </summary>
    
      <category term="Tech" scheme="http://yoursite.com/categories/Tech/"/>
    
    
      <category term="laravel" scheme="http://yoursite.com/tags/laravel/"/>
    
      <category term="websockets" scheme="http://yoursite.com/tags/websockets/"/>
    
  </entry>
  
</feed>
